---
title: "PGS Educational Attainment"
author: Sebastian Marten & Amaury Pelzer
output: rmdformats::robobook
---

```{r, include=FALSE}
if (suppressWarnings(!require(tidyverse))) {install.packages("tidyverse"); library(tidyverse)}
if (suppressWarnings(!require(ggplot2))) {install.packages("ggplot2"); library(ggplot2)}
if (suppressWarnings(!require(data.table))) {install.packages("data.table"); library(data.table)}
if (suppressWarnings(!require(formattable))) {install.packages("formattable"); library(formattable)}
if (suppressWarnings(!require(survival))) {install.packages("survival"); library(survival)}
if (suppressWarnings(!require(ggsurvfit))) {install.packages("ggsurvfit"); library(ggsurvfit)}
if (suppressWarnings(!require(performance))) {install.packages("performance"); library(performance)}
if (suppressWarnings(!require(cowplot))) {install.packages("cowplot"); library(cowplot)}
if (suppressWarnings(!require(NormPsy))) {install.packages("NormPsy"); library(NormPsy)}
if (suppressWarnings(!require(gridExtra))) {install.packages("gridExtra"); library(gridExtra)}
if (suppressWarnings(!require(rmdformats))) {install.packages("rmdformats"); library(rmdformats)}
```

# Data Preprocessing

1.  First, I wanted to investigate which variables are time dependent and also exclude some that were clearly unnecessary (i.e., "SITE","COLPROT","ORIGPROT", "FLDSTRENG","FSVERSION","IMAGEUID", "Month_bl","Month","M","update_stamp").

```{r, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)

dat <- read.csv("data/ADNIMERGE.csv")

time_test <- function(data, idvar, tvar) {
  x <- data[, c(idvar, tvar)] %>% arrange(tvar)
  time_dependent <- FALSE
  unique_participants <- unique(x[, 1])
  for (participant in unique_participants) {
    participant_data <- x[x[, 1] == participant, 2]
    if (length(unique(participant_data)) > 1) {
      time_dependent <- TRUE
      break
    }
  }
  if (time_dependent) {
    return(data.frame(variable = tvar, status = "Time Dependent"))
  } else {
    return(data.frame(variable = tvar, status = "Time Independent"))
  }
}

results <- data.frame(variable = character(), status = character(), stringsAsFactors = FALSE)

for (col in 1:length(colnames(dat))) {
  result <- time_test(dat, "RID", colnames(dat)[col])
  results <- rbind(results, result)
}


excluded_vars <- c("SITE","COLPROT","ORIGPROT","FLDSTRENG",
                   "FSVERSION","IMAGEUID", "Month_bl","Month","M",
                   "update_stamp", "FSVERSION_bl", "FLDSTRENG_bl", 
                   "EXAMDATE_bl", "EXAMDATE", "Years_bl")

ivars <- subset(results, status=="Time Independent") %>%
  subset(!(variable %in% excluded_vars)) %>% subset(select=variable)

nivars <- subset(results, status=="Time Dependent") %>% 
  subset(!(variable %in% excluded_vars)) %>% subset(select=variable)

rm(results, result, col)
```

2.  Merge time dependent and independent variables into the long_dat data frame. Also, I recoded the time points in the VISCODE variable into integers.

```{r}
long_dat <- dat[, c(ivars[,1], nivars[,1])] %>%
  mutate(VISCODE = match(VISCODE, c("bl", "m03", "m06", "m12", "m18", "m24", 
                                    "m30","m36", "m42", "m48", "m54", "m60", 
                                    "m66", "m72","m78", "m84", "m90", "m96", 
                                    "m102", "m108","m114", "m120", "m126", 
                                    "m132", "m144", "m156"))-1) %>%
  relocate(RID, PTID, VISCODE) %>%
  arrange(RID, VISCODE)
```

3.  In the original data frame there were quite some \_bl or \_BL variables. Thus, I wanted to check whether these columns had already been integrated or not at each corresponding time point for each participant. Surprise, the test was negative.

```{r, include= FALSE}
baseline_vars <- long_dat %>%
  select(c("VISCODE","PTID",ends_with("_bl"),ends_with("_BL"))) %>%
  filter(VISCODE == 0) %>%
  subset(select = -c(DX_bl, VISCODE)) %>%
  rename(LDELTOTAL_bl = LDELTOTAL_BL)

baseline_commplementary_vars <- long_dat %>% 
  
  subset(select = c(VISCODE, DX, CDRSB, ADAS11, ADAS13, ADASQ4,MMSE,
  RAVLT_immediate,RAVLT_learning,RAVLT_forgetting,RAVLT_perc_forgetting,
  LDELTOTAL,DIGITSCOR,TRABSCOR,FAQ,mPACCdigit,mPACCtrailsB,Ventricles,
  Hippocampus,WholeBrain,Entorhinal,Fusiform,MidTemp,ICV,MOCA,EcogPtMem,
  EcogPtLang,EcogPtVisspat,EcogPtPlan,EcogPtOrgan,EcogPtDivatt,EcogPtTotal,
  EcogSPMem,EcogSPLang,EcogSPVisspat,EcogSPPlan,EcogSPOrgan,EcogSPDivatt,
  EcogSPTotal,ABETA,TAU,PTAU,FDG,PIB,AV45)) %>%
  
  filter(VISCODE == 0) %>% 
  subset(select = -c(DX, VISCODE))

length(colnames(baseline_vars)) == length(colnames(baseline_commplementary_vars))
all.equal(baseline_vars, baseline_commplementary_vars)
```

4.  Therefore, I continued with merging the \_bl/\_BL variables with the corresponding time dependent variable for each participant. Additionally, I specified the data type of each variable individually for optimal control and oversight over the data structure.

```{r, include= FALSE}
baseline_commplementary_col_names <- colnames(baseline_commplementary_vars)

long_dat <- long_dat %>%
  left_join(baseline_vars, by = "PTID", suffix = c("", "_bl")) %>%
  mutate(across(all_of(baseline_commplementary_col_names), ~ coalesce(., get(paste0(cur_column(), "_bl"))))) %>%
  select(-ends_with("_bl"), -ends_with("_BL")) %>%
  mutate(
    RID = as.factor(RID),
    PTID = as.character(PTID),
    VISCODE = as.factor(VISCODE),
    AGE = as.numeric(AGE),
    PTGENDER = as.factor(PTGENDER),
    PTEDUCAT = as.integer(PTEDUCAT),
    PTETHCAT = as.factor(PTETHCAT),
    PTRACCAT = as.factor(PTRACCAT),
    PTMARRY = as.factor(PTMARRY),
    APOE4 = as.integer(APOE4),
    FDG = as.numeric(FDG),
    PIB = as.numeric(PIB),
    AV45 = as.numeric(AV45),
    ABETA = as.numeric(ABETA),
    TAU = as.numeric(TAU),
    PTAU = as.numeric(PTAU),
    CDRSB = as.numeric(CDRSB),
    ADAS11 = as.numeric(ADAS11),
    ADAS13 = as.numeric(ADAS13),
    ADASQ4 = as.integer(ADASQ4),
    MMSE = as.integer(MMSE),
    RAVLT_immediate = as.integer(RAVLT_immediate),
    RAVLT_learning = as.integer(RAVLT_learning),
    RAVLT_forgetting = as.integer(RAVLT_forgetting),
    RAVLT_perc_forgetting = as.numeric(RAVLT_perc_forgetting),
    LDELTOTAL = as.integer(LDELTOTAL),
    DIGITSCOR = as.integer(DIGITSCOR),
    TRABSCOR = as.integer(TRABSCOR),
    FAQ = as.integer(FAQ),
    MOCA = as.integer(MOCA),
    EcogPtMem = as.numeric(EcogPtMem),
    EcogPtLang = as.numeric(EcogPtLang),
    EcogPtVisspat = as.numeric(EcogPtVisspat),
    EcogPtPlan = as.numeric(EcogPtPlan),
    EcogPtOrgan = as.numeric(EcogPtOrgan),
    EcogPtDivatt = as.numeric(EcogPtDivatt),
    EcogPtTotal = as.numeric(EcogPtTotal),
    EcogSPMem = as.numeric(EcogSPMem),
    EcogSPLang = as.numeric(EcogSPLang),
    EcogSPVisspat = as.numeric(EcogSPVisspat),
    EcogSPPlan = as.numeric(EcogSPPlan),
    EcogSPOrgan = as.numeric(EcogSPOrgan),
    EcogSPDivatt = as.numeric(EcogSPDivatt),
    EcogSPTotal = as.numeric(EcogSPTotal),
    Ventricles = as.integer(Ventricles),
    Hippocampus = as.integer(Hippocampus),
    WholeBrain = as.integer(WholeBrain),
    Entorhinal = as.integer(Entorhinal),
    Fusiform = as.integer(Fusiform),
    MidTemp = as.integer(MidTemp),
    ICV = as.integer(ICV),
    DX = as.factor(DX),
    mPACCdigit = as.numeric(mPACCdigit),
    mPACCtrailsB = as.numeric(mPACCtrailsB)
    )
```

5.  Transform Long to Wide Data Format

```{r, echo=FALSE}
ivars <- ivars %>% filter(!str_detect(variable, "_bl|_BL") & variable != "DX_bl") %>%
  pull(variable) %>%
  as.character()

nivars <- nivars %>% 
  filter(! str_detect(variable, "VISCODE")) %>%
  pull(variable) %>%
  as.character()

wide_dat <- pivot_wider(
  long_dat,
  id_cols = all_of(ivars),
  names_from = "VISCODE",
  values_from = all_of(nivars),
  values_fn = list(n = n_distinct),
  names_sep = "_"
  )

head(wide_dat)
```

# Age Distribution in Data Frame

```{r, echo=FALSE, warning=FALSE}

# Create histogram of general age range in data set

ggplot(long_dat %>% distinct(RID, .keep_all = TRUE), aes(x = AGE)) +
  geom_histogram(binwidth = 1, fill = "#bbceed", color = "black") +
  geom_vline(xintercept = c(60, 70), linetype = "dashed", color = "#940914", size=1) +  # vertical lines age range
  geom_vline(xintercept = c(65, 75), linetype = "dashed", color = "#940914", size=1) +  # vertical lines age range
  labs(title = "Histogram Age Distribution",
       x = "Age",
       y = "Frequency") +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", hjust = 0.5),  # Bold and centred title
        axis.line = element_line(size = 0.5))  # Thicker axis lines

# create data frames of two age groups

age_60to70_df <- long_dat %>% # Data frame filtered for age
  filter(AGE >= 60 & AGE <= 70)

age_65to75_df <- long_dat %>% # Data frame filtered for age
  filter(AGE >= 65 & AGE <= 75)

age_60to75_df <- long_dat %>% # Data frame filtered for age
  filter(AGE >= 60 & AGE <= 75)

# AGE Groups (1,2,3 for 60-65, 66-70, 71-75)

long_dat$Age_Group <- ifelse(
  long_dat$AGE >= 60.0 & long_dat$AGE <= 65.0, 1,
  ifelse(
    long_dat$AGE >= 66.0 & long_dat$AGE <= 70.0, 2,
    ifelse(
      long_dat$AGE >= 71.0 & long_dat$AGE <= 75.0, 3,
      NA_integer_
    )
  )
)

# Append to Wide data frame too 
wide_dat <- wide_dat %>%
  left_join(
    long_dat %>% 
      group_by(RID) %>%
      filter(row_number() == 1) %>%  # Keep only the first row for each unique RID
      select(RID, Age_Group),
    by = "RID"
  )
```

# Attrition Analysis

Based on the number of participants measured at any time point I made a frequency plot to get a first idea of the sampling frequency.

```{r, echo=FALSE, fig.align="center"}
frequency_table <- long_dat %>%
  group_by(VISCODE) %>%
  summarise(NumParticipants = n_distinct(RID))

barplot(frequency_table$NumParticipants~frequency_table$VISCODE, xlab="Time", ylab="Number of Patients Measured",
     main="Attrition Plot")
```

# Domains

## Demographics

```{r, echo=FALSE}
df_demographics <- long_dat %>%
  select(RID, PTID, VISCODE, AGE, PTGENDER, PTEDUCAT, PTETHCAT, PTRACCAT, PTMARRY)

freq_dem <- df_demographics %>%
  group_by(VISCODE) %>%
  summarise(across(everything(), ~ sum(!is.na(.))))

freq_dem_long <- pivot_longer(freq_dem, cols = -VISCODE, names_to = "Variable", values_to = "Frequency")

ggplot(freq_dem_long, aes(x = VISCODE, y = Frequency, color = Variable, group = Variable)) +
  geom_line() +
  labs(x = "Timepoint (VISCODE)", y = "Number of Measurements", title = "Number of Measurements per Time Point") +
  theme(legend.position = "top")
```

## Cognitive Tests

```{r, echo=FALSE}
df_cognitive_tests <- long_dat %>%
  select(RID, PTID, VISCODE, CDRSB, ADAS11, ADAS13, ADASQ4, MMSE,
         RAVLT_immediate, RAVLT_learning, RAVLT_forgetting, RAVLT_perc_forgetting,
         LDELTOTAL, DIGITSCOR, TRABSCOR, FAQ, MOCA,
         EcogPtMem, EcogPtLang, EcogPtVisspat, EcogPtPlan, EcogPtOrgan, EcogPtDivatt, EcogPtTotal,
         EcogSPMem, EcogSPLang, EcogSPVisspat, EcogSPPlan, EcogSPOrgan, EcogSPDivatt, EcogSPTotal)

freq_cog <- df_cognitive_tests %>%
  group_by(VISCODE) %>%
  summarise(across(everything(), ~ sum(!is.na(.))))

freq_cog_long <- pivot_longer(freq_cog, cols = -VISCODE, names_to = "Variable", values_to = "Frequency")

ggplot(freq_cog_long, aes(x = VISCODE, y = Frequency, color = Variable, group = Variable)) +
  geom_line() +
  labs(x = "Timepoint (VISCODE)", y = "Number of Measurements", title = "Number of Measurements per Time Point") +
  theme(legend.position = "top")
```

## Biomedical Imaging

```{r,echo=FALSE}
df_biomedical_imaging <- long_dat %>%
  select(RID, PTID, VISCODE, Ventricles, Hippocampus, WholeBrain, Entorhinal, Fusiform, MidTemp, ICV)

freq_imag <- df_biomedical_imaging %>%
  group_by(VISCODE) %>%
  summarise(across(everything(), ~ sum(!is.na(.))))

freq_imag_long <- pivot_longer(freq_imag, cols = -VISCODE, names_to = "Variable", values_to = "Frequency")

ggplot(freq_imag_long, aes(x = VISCODE, y = Frequency, color = Variable, group = Variable)) +
  geom_line() +
  labs(x = "Timepoint (VISCODE)", y = "Number of Measurements", title = "Number of Measurements per Time Point") +
  theme(legend.position = "top")
```

## Biomarkers

```{r, echo=FALSE}
df_biomarkers <- long_dat %>%
  select(RID, PTID, VISCODE, APOE4, ABETA, TAU, PTAU, FDG, PIB, AV45)

freq_mark <- df_biomarkers %>%
  group_by(VISCODE) %>%
  summarise(across(everything(), ~ sum(!is.na(.))))

freq_mark_long <- pivot_longer(freq_mark, cols = -VISCODE, names_to = "Variable", values_to = "Frequency")

ggplot(freq_mark_long, aes(x = VISCODE, y = Frequency, color = Variable, group = Variable)) +
  geom_line() +
  labs(x = "Timepoint (VISCODE)", y = "Number of Measurements", title = "Number of Measurements per Time Point") +
  theme(legend.position = "top")
```

Based on these findings it appears that time point 9 is a cut-off where the number of measurements drop quite strongly. Time point 9 corresponds to month 42 (i.e., 3.5 years) of the follow-up.

```{r, echo=FALSE}
rm(list= setdiff(ls(), c("long_dat", "wide_dat")))
```

# Polygenic Score for Educational attainment

```{r, echo=FALSE, message=FALSE}
# Read in the PGS send to us by Rick
pgs <- readr::read_tsv("data/ADNI_PRS_results_EA_EA22.tsv")

# Merge the EA data with the corresponding participant in each data frame
long_dat <- merge(long_dat, pgs,by.x="PTID",by.y="SampleID") 
wide_dat <- merge(wide_dat, pgs,by.x="PTID",by.y="SampleID")
```

The merge(by.x, by.y) function creates a new data frame that only keeps those rows for which there is a matching key (in our case PTID). Therefore, we do have genetic data from 2 additional individuals for which we do not have any other measurements. The final data frame for which testing data and genetic data is available is thus, 1408 (N).

## Plot PGS EA vs. Actual EA

Based on this plot, we can see a positive relationship between the polygenic score for education attainment and actual years of education. This means that with a higher PGS score comes higher genetic capacity for educational attainment.

We ran Pearson's correlation which resulted in r = 0.286 (p-value \< 2.2e-16)

```{r, echo=FALSE, message=FALSE, results='hide'}
# Plot PGS EA against Actual EA
ggplot(long_dat, aes(x = PTEDUCAT, y = EA22)) +
  geom_point() +  # Add points
  geom_smooth(method = "lm") +  # Add linear regression line
  labs(x = "Years of Education", y = "EA22") +  # Set axis labels
  ggtitle("EA22 vs Years of Education")  # Set plot title

cor(long_dat$PTEDUCAT, long_dat$EA22, method="pearson")
cor.test(long_dat$PTEDUCAT, long_dat$EA22, method="pearson")
```

## Check linear regression assumptions

```{r}
# Linear regression model
model <- lm(PTEDUCAT~EA22+AGE+PTGENDER,data=long_dat)

# Check model assumptions
check_model(model)
```

## Create Residuals

To get the residual we regressed the polygenic risk score for educational attainment against actual EA including the variables SEX & AGE as covariates. The results are depicted in the density plot.

```{r, echo=FALSE}
# Create the residuals given two covariates AGE and Sex
results <- lm(PTEDUCAT~EA22+AGE+PTGENDER,data=long_dat)

# Standardize the residuals and append to data frame
long_dat$res <- rstandard(results)

# Create density plot of the residuals
ggplot(long_dat, aes(x = res)) +
  geom_density(fill = "orange", alpha = 0.5) +
  labs(x = "Residual Score", y = "Density") +
  ggtitle("Distribution of Residuals")
```

## How to interpret the Residuals?

It is important to correctly interpret the residual scores. The correct way to interpret them is, that a high residual score means that the individual has over-performed relative to his or her genetic capacity. See for example in this table for a short proof:

```{r, echo=FALSE}
residuals <- results$residuals # get residuals
predicted_scores <- predict(results) # get predicted scores for each individual

combined_df <- data.frame(Actual = long_dat$PTEDUCAT, Predicted = as.numeric(predicted_scores), Residuals = as.numeric(residuals)) # Combine residuals, predicted scores, and actual scores into one data frame

head(combined_df %>% filter(!duplicated(Actual))) # present data frame as example
```

```{r, echo=FALSE}
# Create a residual plot
ggplot() +
  geom_qq(aes(sample = residuals)) +
  geom_qq_line() +
  labs(title = "Normal Q-Q Plot of Residuals") +
  theme_minimal()
```

# Survival Analysis

Using the ntile function from dplyr, the lower tertile will be assigned value 1 (\~ negative residual), middle tertile value 2 and upper tertile value 3 (\~positive residual). The time-point is limited to the 9th follow-up (i.e., 48 months)

```{r, echo=FALSE}
# Divide the standardized residuals into upper, middle and lower quartile
long_dat$thirtile_res <- ntile(long_dat$res, 3)

# Divide the PGS score for educational attainment into upper, middle and lower quartile
long_dat$thirtile_PGS <- ntile(long_dat$EA22, 3)
```

## Mini-Mental State Examination (MMSE)

"The mini--mental state examination (MMSE) is a 30-point questionnaire that is used extensively in clinical and research settings to measure cognitive impairment. It is commonly used in medicine and allied health to screen for dementia. It is also used to estimate the severity and progression of cognitive impairment and to follow the course of cognitive changes in an individual over time; thus making it an effective way to document an individual's response to treatment.Administration of the test takes between 5 and 10 minutes and examines functions including registration (repeating named prompts), attention and calculation, recall, language, ability to follow simple commands and orientation. [...] Any score of 24 or more (out of 30) indicates a normal cognition. Below this, scores can indicate severe (≤9 points), moderate (10--18 points) or mild (19-23 points) cognitive impairment." (Wikipedia.org). The MMSE scores were normalized using the NormPsy package and then the cut-off was calculated.

```{r, echo=FALSE}

cvalue <- list() # initialize list of cut-off values
logrank_test <- list() # initialize list of log-rank tests

long_dat$MMSE_norm <- normMMSE(long_dat$MMSE) # normalize MMSE

cvalue$MMSE_norm <- wide_dat %>% # Calculate cut-off value for normalized MMSE
    filter(DX_0 == "CN") %>%
    summarize(
      value := mean(normMMSE(MMSE_0), na.rm = TRUE) - 2 * sd(normMMSE(MMSE_0), na.rm = TRUE)
    ) %>%
    pull(value)

long_dat$MMSE_cut <- ifelse(long_dat$MMSE_norm < cvalue$MMSE_norm, 1, 0) # Group individuals by cut-off value

```

### Boxplots of MMSE by Age Group at Baseline

To see if it is necessary to stratify for age groups effect of polygenic risk score for EA and age group was tested using linear regression. The results are displayed below.

```{r, echo=FALSE}
filtered_long_dat <- long_dat %>% #filter out NA cases (== AGE is not between 60-75)
  filter(!is.na(Age_Group), VISCODE==0)

# Boxplot for MMSE by Age Group
box1 <- ggplot(filtered_long_dat, aes(x = factor(Age_Group), y = MMSE)) +
  geom_boxplot(fill = c("#6d8fa6", "#8596a1","#bbceed"), color = "black") + # Set fill and border colours
  scale_x_discrete(labels = c("60-65", "66-70", "71-75")) + # Set x axis scale labels
  labs(x = "Age Group", y = "MMSE Score") +
  theme_minimal() +
  theme(axis.line = element_line(size = 0.5),
        plot.title = element_text(hjust = 0.5, face = "bold", size = 14),  # Adjust title
        axis.title = element_text(size = 12),  # Adjust axis title font size
        axis.text = element_text(size = 10),   # Adjust axis text font size
        panel.grid.major = element_blank(),     # Remove major grid lines
        panel.grid.minor = element_blank()) +   # Remove minor grid lines
  ggtitle("Boxplot of raw MMSE at baseline by Age Group") +
  theme(plot.title = element_text(size = 9)) # Custom title     # Custom title


# Boxplot for normMMSE by Age Group
box2 <- ggplot(filtered_long_dat, aes(x = factor(Age_Group), y = MMSE_norm)) +
  geom_boxplot(fill = c("#6d8fa6", "#8596a1","#bbceed"), color = "black") + # Set fill and border colours
  scale_x_discrete(labels = c("60-65", "66-70", "71-75")) + # Set x axis scale labels
  labs(x = "Age Group", y = "MMSE Score") +
  theme_minimal() +
  theme(axis.line = element_line(size = 0.5),
        plot.title = element_text(hjust = 0.5, face = "bold", size = 14),  # Adjust title
        axis.title = element_text(size = 12),  # Adjust axis title font size
        axis.text = element_text(size = 10),   # Adjust axis text font size
        panel.grid.major = element_blank(),     # Remove major grid lines
        panel.grid.minor = element_blank()) +   # Remove minor grid lines
  ggtitle("Boxplot of norm MMSE at baseline by Age Group") +
  theme(plot.title = element_text(size = 9)) # Custom title

res <- lm(MMSE ~ EA22 + Age_Group, data = long_dat)
res2 <- lm(MMSE_norm ~ EA22 + Age_Group, data = long_dat)

grid.arrange(box1, box2, ncol = 2)
summary(res)
summary(res2)

rm(filtered_long_dat, box1, box2, res, res2)
```

### MMSE Survival Analysis

Next the survival analysis was conducted for the genetic capacity of educational attainment and the residual educational attainment.

```{r, echo=FALSE, fig.width = 10}

################################################################################
# MMSE~Genetic Capacity
################################################################################

# Fit the Kaplan-Meier estimator (MMSE~PGS)

surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9, AGE>=60, AGE<=75) %>%
  survfit(Surv(as.integer(VISCODE), MMSE_cut) ~ thirtile_PGS, data = .)

# Create the Kaplan-Meier survival plot (MMSE~PGS)
par(mfrow=c(1,2))

plot(surv_fit, 
     main = "Kaplan-Meier Survival Curve (MMSE~PGS)", 
     xlab = "Time", 
     ylab = "Survival Probability", 
     col = c("#021636", "#bbceed", "#0a77f5"), 
     lwd = 2,
     xlim = c(0, 10),
     cex.main = 0.95) 

legend("bottomleft", 
       legend = c("Low capacity", "Average", "High capacity"), 
       col = c("#021636", "#bbceed", "#0a77f5"), 
       lwd = 2)

axis(1, lwd = 1)  # Change x-axis thickness
axis(2, lwd = 1)  # Change y-axis thickness

# Log Rank Test (MMSE~PGS)
logrank_test$MMSE_PGS <- long_dat %>%
  filter(as.integer(VISCODE) <= 9, thirtile_PGS != 2, AGE>=60, AGE<=75) %>%
  survdiff(Surv(as.integer(VISCODE), MMSE_cut) ~ thirtile_PGS, data = .)

################################################################################
# MMSE~Residual EA
################################################################################

# Fit the Kaplan-Meier estimator (MMSE~res)

surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9, AGE>=60, AGE<=75) %>%
  survfit(Surv(as.integer(VISCODE), MMSE_cut) ~ thirtile_res, data = .)

# Create the Kaplan-Meier survival plot (MMSE~res)

plot(surv_fit, 
     main = "Kaplan-Meier Survival Curve (MMSE~res)", 
     xlab = "Time", 
     ylab = "Survival Probability", 
     col = c("#021636", "#bbceed", "#0a77f5"), 
     lwd = 2,
     xlim = c(0, 10),
     cex.main = 0.95)  # Adjust the size of the title 

legend("bottomleft", 
       legend = c("Underperformed", "Average", "Overperformed"), 
       col = c("#021636", "#bbceed", "#0a77f5"), 
       lwd = 2)

axis(1, lwd = 1)  # Change x-axis thickness
axis(2, lwd = 1)  # Change y-axis thickness

# Log Rank Test (MMSE~res)

logrank_test$MMSE_res <- long_dat %>%
  filter(as.integer(VISCODE) <= 9, thirtile_res != 2, AGE>=60, AGE<=75) %>%
  survdiff(Surv(as.integer(VISCODE), MMSE_cut) ~ thirtile_res, data = .)
```

The difference between the high and low capacity/residual Educational attainment are `r logrank_test$MMSE_PGS$pvalue` and `r logrank_test$MMSE_res$pvalue` respectively. In the next step the survival analysis was conducted stratified for genetic capacity for educational attainment.

```{r, echo=FALSE, fig.width = 12}

par(mfrow=c(1,3)) # Set parameters for plots

################################################################################
# MMSE~Residual EA by Genetic Capacity (Low)
################################################################################

# Fit the Kaplan-Meier estimator

surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9, AGE>=60, AGE<=75, thirtile_PGS==1) %>%
  survfit(Surv(as.integer(VISCODE), MMSE_cut) ~ thirtile_res, data = .)

# Create the Kaplan-Meier survival plot

plot(surv_fit, 
     main = "Kaplan-Meier Survival Curve (Low PGS)", 
     xlab = "Time", 
     ylab = "Survival Probability", 
     col = c("#021636", "#bbceed", "#0a77f5"), 
     lwd = 2,
     xlim = c(0, 10),
     cex.main = 0.95) 

legend("bottomleft", 
       legend = c("Underachiever", "Average", "Overachiever"), 
       col = c("#021636", "#bbceed", "#0a77f5"), 
       lwd = 2)

axis(1, lwd = 1)  # Change x-axis thickness
axis(2, lwd = 1)  # Change y-axis thickness

# Log Rank Test 

logrank_test$MMSE_res_low <- long_dat %>%
  filter(as.integer(VISCODE) <= 9, 
         thirtile_res != 2, 
         thirtile_PGS==1) %>% # Low PGS
  survdiff(Surv(as.integer(VISCODE), MMSE_cut) ~ thirtile_res, data = .)

################################################################################
# MMSE~Residual EA by Genetic Capacity (Middle)
################################################################################

# Fit the Kaplan-Meier estimator

surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9, AGE>=60, AGE<=75, thirtile_PGS==2) %>%
  survfit(Surv(as.integer(VISCODE), MMSE_cut) ~ thirtile_res, data = .)

# Create the Kaplan-Meier survival plot

plot(surv_fit, 
     main = "Kaplan-Meier Survival Curve (Middle PGS)", 
     xlab = "Time", 
     ylab = "Survival Probability", 
     col = c("#021636", "#bbceed", "#0a77f5"), 
     lwd = 2,
     xlim = c(0, 10),
     cex.main = 0.95) 

legend("bottomleft", 
       legend = c("Underachiever", "Average", "Overachiever"), 
       col = c("#021636", "#bbceed", "#0a77f5"), 
       lwd = 2)

axis(1, lwd = 1)  # Change x-axis thickness
axis(2, lwd = 1)  # Change y-axis thickness

# Log Rank Test 

logrank_test$MMSE_res_mid <- long_dat %>%
  filter(as.integer(VISCODE) <= 9, 
         thirtile_res != 2, 
         thirtile_PGS==2) %>% # Middle PGS
  survdiff(Surv(as.integer(VISCODE), MMSE_cut) ~ thirtile_res, data = .)

################################################################################
# MMSE~Residual EA by Genetic Capacity (High)
################################################################################

# Fit the Kaplan-Meier estimator

surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9, AGE>=60, AGE<=75, thirtile_PGS==3) %>%
  survfit(Surv(as.integer(VISCODE), MMSE_cut) ~ thirtile_res, data = .)

# Create the Kaplan-Meier survival plot

plot(surv_fit, 
     main = "Kaplan-Meier Survival Curve (High PGS)", 
     xlab = "Time", 
     ylab = "Survival Probability", 
     col = c("#021636", "#bbceed", "#0a77f5"), 
     lwd = 2,
     xlim = c(0, 10),
     cex.main = 0.95) 

legend("bottomleft", 
       legend = c("Underachiever", "Average", "Overachiever"), 
       col = c("#021636", "#bbceed", "#0a77f5"), 
       lwd = 2)

axis(1, lwd = 1)  # Change x-axis thickness
axis(2, lwd = 1)  # Change y-axis thickness

# Log Rank Test

logrank_test$MMSE_res_high <- long_dat %>%
  filter(as.integer(VISCODE) <= 9, 
         thirtile_res != 2, 
         thirtile_PGS==3) %>% # High PGS
  survdiff(Surv(as.integer(VISCODE), MMSE_cut) ~ thirtile_res, data = .)
```

```{r, include=FALSE}
################################################################################
# Histogram # people by time point by group by outcome
################################################################################

ggplot(long_dat %>% filter(!is.na(MMSE_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(MMSE_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("#bbceed", "#021636"), labels = c("Normal Cognition", "Impaired Cognition")) +
  facet_wrap(~ thirtile_res, ncol = 3, 
             labeller = labeller(thirtile_res = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal() +
  theme(axis.line = element_line(size = 0.5),
        plot.title = element_text(hjust = 0.5, face = "bold")) +
  geom_vline(xintercept = 9, linetype = "dashed", color = "#940914")  # Add  vertical dashed line
```

Log Test Low: `r logrank_test$MMSE_res_low$pvalue`<br>
Log Test Middle: `r logrank_test$MMSE_res_mid$pvalue`<br>
Log Test High:`r logrank_test$MMSE_res_high$pvalue`

## Alzheimer's Disease Assessment Scale

The Cognitive Subscale Alzheimer's Disease Assessment Scale (ADAS) is made of 11 tasks that include both subject-completed tests and observer-based assessments, assessing the memory, language, and praxis domains. The result is a global final score ranging from 0 to 70, based on the sum of the scores of the single tasks (ADAS11).

Beyond the ADAS11 score, the ADNI study included also an additional test of delayed word recall and a number cancellation or maze task, which are further summed to have a new total score that ranges from 0 to 85 (ADAS13).

In addition, the score of the task 4 (Word Recognition, ADASQ4) was included in the ADNIMERGE dataset.

([Grassi et al., 2019](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6646724/))

### ADAS11

```{r, echo=FALSE, message=FALSE}

calculate_cvalue <- function(variable) {
  var_bl <- paste0(deparse(substitute(variable)), "_0")
  
  value <- wide_dat %>%
    filter(DX_0 == "CN") %>%
    summarize(
      {{ variable }} := mean(.[[ var_bl ]], na.rm = TRUE) + 2 * sd(.[[ var_bl ]], na.rm = TRUE)
    ) %>%
    pull({{ variable }})  # Extract the calculated value
    
  return(value)
}

cvalue$ADAS11 <- calculate_cvalue(ADAS11)

long_dat$ADAS11_cut <- ifelse(long_dat$ADAS11 > cvalue$ADAS11, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), ADAS11_cut) ~ thirtile_res, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, 
     main = "Kaplan-Meier Survival Curve", 
     xlab = "Time", 
     ylab = "Survival Probability", 
     col = c("#021636", "#bbceed", "#0a77f5"), 
     lwd = 2,
     xlim = c(0, 10)) 

legend("bottomleft", 
       legend = c("Underachiever", "Average", "Overachiever"), 
       col = c("#021636", "#bbceed", "#0a77f5"), 
       lwd = 2)

axis(1, lwd = 1)  # Change x-axis thickness
axis(2, lwd = 1)  # Change y-axis thickness

# Log Rank Test 
logrank_test$ADAS11 <- long_dat %>%
  filter(as.integer(VISCODE) <= 9, thirtile_res != 2) %>%
  survdiff(Surv(as.integer(VISCODE), ADAS11_cut) ~ thirtile_res, data = .)
logrank_test$ADAS11

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(ADAS11_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(ADAS11_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("#bbceed", "#021636"), labels = c("Normal Cognition", "Impaired Cognition")) +
  facet_wrap(~ thirtile_res, ncol = 3, 
             labeller = labeller(thirtile_res = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal() +
  theme(axis.line = element_line(size = 0.5),
        plot.title = element_text(hjust = 0.5, face = "bold")) +
  geom_vline(xintercept = 9, linetype = "dashed", color = "#940914")  # Add  vertical dashed line
```

### ADAS13

"The ADAS13 was included as a global measure of cognitive function. ADAS13 is a test battery developed to assess severity of cognitive impairment associated with AD and includes subtests and clinical evaluations assessing memory function, reasoning, language function, orientation and praxis. The ADAS13 is a modified version of the original ADAS-Cog-11, adding a cancellation task and a delayed free recall task. The higher the scores, the more severe impairment of cognitive function." (Mofrad et al., 2021)

```{r, echo=FALSE, message=FALSE}
cvalue$ADAS13 <- calculate_cvalue(ADAS13)

long_dat$ADAS13_cut <- ifelse(long_dat$ADAS13 > cvalue$ADAS13, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), ADAS13_cut) ~ thirtile_res, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, 
     main = "Kaplan-Meier Survival Curve", 
     xlab = "Time", 
     ylab = "Survival Probability", 
     col = c("#021636", "#bbceed", "#0a77f5"), 
     lwd = 2,
     xlim = c(0, 10)) 

legend("bottomleft", 
       legend = c("Underachiever", "Average", "Overachiever"), 
       col = c("#021636", "#bbceed", "#0a77f5"), 
       lwd = 2)

axis(1, lwd = 1)  # Change x-axis thickness
axis(2, lwd = 1)  # Change y-axis thickness

# Log Rank Test 
logrank_test$ADAS13 <- long_dat %>%
  filter(thirtile_res != 2) %>%
  survdiff(Surv(as.integer(VISCODE), ADAS13_cut) ~ thirtile_res, data = .)
logrank_test$ADAS13

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(ADAS13_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(ADAS13_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("#bbceed", "#021636"), labels = c("Normal Cognition", "Impaired Cognition")) +
  facet_wrap(~ thirtile_res, ncol = 3, 
             labeller = labeller(thirtile_res = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal() +
  theme(axis.line = element_line(size = 0.5),
        plot.title = element_text(hjust = 0.5, face = "bold")) +
  geom_vline(xintercept = 9, linetype = "dashed", color = "#940914")  # Add  vertical dashed line
```

### ADASQ4

```{r, echo=FALSE, message=FALSE}
cvalue$ADASQ4 <- calculate_cvalue(ADASQ4)

long_dat$ADASQ4_cut <- ifelse(long_dat$ADASQ4 > cvalue$ADASQ4, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), ADASQ4_cut) ~ thirtile_res, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, 
     main = "Kaplan-Meier Survival Curve", 
     xlab = "Time", 
     ylab = "Survival Probability", 
     col = c("#021636", "#bbceed", "#0a77f5"), 
     lwd = 2,
     xlim = c(0, 10)) 

legend("bottomleft", 
       legend = c("Underachiever", "Average", "Overachiever"), 
       col = c("#021636", "#bbceed", "#0a77f5"), 
       lwd = 2)

axis(1, lwd = 1)  # Change x-axis thickness
axis(2, lwd = 1)  # Change y-axis thickness

# Log Rank Test 
logrank_test$ADASQ4 <- long_dat %>%
  filter(thirtile_res != 2) %>%
  survdiff(Surv(as.integer(VISCODE), ADASQ4_cut) ~ thirtile_res, data = .)
logrank_test$ADASQ4

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(ADASQ4_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(ADASQ4_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("#bbceed", "#021636"), labels = c("Normal Cognition", "Impaired Cognition")) +
  facet_wrap(~ thirtile_res, ncol = 3, 
             labeller = labeller(thirtile_res = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal() +
  theme(axis.line = element_line(size = 0.5),
        plot.title = element_text(hjust = 0.5, face = "bold")) +
  geom_vline(xintercept = 9, linetype = "dashed", color = "#940914")  # Add  vertical dashed line
```

## CDRSB

"The clinical dementia rating (CDR) scale is commonly used to diagnose dementia due to Alzheimer's disease (AD). The sum of boxes of the CDR (CDR-SB) has recently been emphasized and applied to interventional trials for tracing the progression of cognitive impairment (CI) in the early stages of AD." ([Tzeng et al., 2022](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC9537043/))

See [Table 3](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3409562/table/T3/?report=objectonly) for explanation on the staging category ([O'Bryant et al., 2012](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3409562/))

```{r, echo=FALSE, message=FALSE}
cvalue$CDRSB <- calculate_cvalue(CDRSB)

long_dat$CDRSB_cut <- ifelse(long_dat$CDRSB > cvalue$CDRSB, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), CDRSB_cut) ~ thirtile_res, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, 
     main = "Kaplan-Meier Survival Curve", 
     xlab = "Time", 
     ylab = "Survival Probability", 
     col = c("#021636", "#bbceed", "#0a77f5"), 
     lwd = 2,
     xlim = c(0, 10)) 

legend("bottomleft", 
       legend = c("Underachiever", "Average", "Overachiever"), 
       col = c("#021636", "#bbceed", "#0a77f5"), 
       lwd = 2)

axis(1, lwd = 1)  # Change x-axis thickness
axis(2, lwd = 1)  # Change y-axis thickness

# Log Rank Test 
logrank_test$CDRSB <- long_dat %>%
  filter(thirtile_res != 2) %>%
  survdiff(Surv(as.integer(VISCODE), CDRSB_cut) ~ thirtile_res, data = .)
logrank_test$CDRSB

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(CDRSB_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(CDRSB_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("#bbceed", "#021636"), labels = c("Normal Cognition", "Impaired Cognition")) +
  facet_wrap(~ thirtile_res, ncol = 3, 
             labeller = labeller(thirtile_res = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal() +
  theme(axis.line = element_line(size = 0.5),
        plot.title = element_text(hjust = 0.5, face = "bold")) +
  geom_vline(xintercept = 9, linetype = "dashed", color = "#940914")  # Add  vertical dashed line
```

## DIGITSCORE

"The DSST (Digit Symbol Substitution Test) is a paper-and-pencil cognitive test presented on a single sheet of paper that requires a subject to match symbols to numbers according to a key located on the top of the page. The subject copies the symbol into spaces below a row of numbers. The number of correct symbols within the allowed time, usually 90 to 120 seconds, constitutes the score." ([Jaeger, 2018](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6291255/)) The lower the scores, the more severe impairment of cognitive function.

```{r, echo=FALSE, message=FALSE}
cvalue$DIGITSCOR <- wide_dat %>%
    filter(DX_0 == "CN") %>%
    summarize(
      value := mean(DIGITSCOR_0, na.rm = TRUE) - 2 * sd(DIGITSCOR_0, na.rm = TRUE)
    ) %>%
    pull(value)

long_dat$DIGITSCOR_cut <- ifelse(long_dat$DIGITSCOR < cvalue$DIGITSCOR, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), DIGITSCOR_cut) ~ thirtile_res, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, 
     main = "Kaplan-Meier Survival Curve", 
     xlab = "Time", 
     ylab = "Survival Probability", 
     col = c("#021636", "#bbceed", "#0a77f5"), 
     lwd = 2,
     xlim = c(0, 10)) 

legend("bottomleft", 
       legend = c("Underachiever", "Average", "Overachiever"), 
       col = c("#021636", "#bbceed", "#0a77f5"), 
       lwd = 2)

axis(1, lwd = 1)  # Change x-axis thickness
axis(2, lwd = 1)  # Change y-axis thickness

# Log Rank Test 
logrank_test$DIGITSCOR <- long_dat %>%
  filter(thirtile_res != 2) %>%
  survdiff(Surv(as.integer(VISCODE), DIGITSCOR_cut) ~ thirtile_res, data = .)
logrank_test$DIGITSCOR

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(DIGITSCOR_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(DIGITSCOR_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("#bbceed", "#021636"), labels = c("Normal Cognition", "Impaired Cognition")) +
  facet_wrap(~ thirtile_res, ncol = 3, 
             labeller = labeller(thirtile_res = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal() +
  theme(axis.line = element_line(size = 0.5),
        plot.title = element_text(hjust = 0.5, face = "bold")) +
  geom_vline(xintercept = 9, linetype = "dashed", color = "#940914")  # Add  vertical dashed line
```

## FAQ

The Functional Activities Questionnaire is used to assess an individual's functional abilities in daily living activities. It is a caregiver-based questionnaire that helps evaluate how well a person is able to perform various instrumental activities of daily living (IADLs) and basic activities of daily living (ADLs). (ChatGPT) Sum scores (range 0-30). The score range for each item is 0--3 (higher scores indicate greater impairment; 0 = normal or never did but could do now; 1 = has difficulty but does by self or never did but would have difficulty now; 2 = requires assistance; 3 = dependent). There is no established cut-off score for IADL impairment on the FAQ. However, one study reported that a total FAQ score (sum of all 10 item scores; range 0--30) of ≥ 6 is suggestive of functional impairment [ [20](https://pubmed.ncbi.nlm.nih.gov/15592138/)]. ([Marshall et al., 2015](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4448081/))

```{r, echo=FALSE, message=FALSE}
cvalue$FAQ <- 5

long_dat$FAQ_cut <- ifelse(long_dat$FAQ > cvalue$FAQ, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), FAQ_cut) ~ thirtile_res, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, 
     main = "Kaplan-Meier Survival Curve", 
     xlab = "Time", 
     ylab = "Survival Probability", 
     col = c("#021636", "#bbceed", "#0a77f5"), 
     lwd = 2,
     xlim = c(0, 10)) 

legend("bottomleft", 
       legend = c("Underachiever", "Average", "Overachiever"), 
       col = c("#021636", "#bbceed", "#0a77f5"), 
       lwd = 2)

axis(1, lwd = 1)  # Change x-axis thickness
axis(2, lwd = 1)  # Change y-axis thickness

# Log Rank Test 
logrank_test$FAQ <- long_dat %>%
  filter(thirtile_res != 2) %>%
  survdiff(Surv(as.integer(VISCODE), FAQ_cut) ~ thirtile_res, data = .)
logrank_test$FAQ

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(FAQ_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(FAQ_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("#bbceed", "#021636"), labels = c("Normal Cognition", "Impaired Cognition")) +
  facet_wrap(~ thirtile_res, ncol = 3, 
             labeller = labeller(thirtile_res = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal() +
  theme(axis.line = element_line(size = 0.5),
        plot.title = element_text(hjust = 0.5, face = "bold")) +
  geom_vline(xintercept = 9, linetype = "dashed", color = "#940914")  # Add  vertical dashed line
```

## LDELTOTAL

```{r, echo=FALSE, message=FALSE}
cvalue$LDELTOTAL <- wide_dat %>%
    filter(DX_0 == "CN") %>%
    summarize(
      value := mean(LDELTOTAL_0, na.rm = TRUE) - 2 * sd(LDELTOTAL_0, na.rm = TRUE)
    ) %>%
    pull(value)

long_dat$LDELTOTAL_cut <- ifelse(long_dat$LDELTOTAL < cvalue$LDELTOTAL, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), LDELTOTAL_cut) ~ thirtile_res, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, 
     main = "Kaplan-Meier Survival Curve", 
     xlab = "Time", 
     ylab = "Survival Probability", 
     col = c("#021636", "#bbceed", "#0a77f5"), 
     lwd = 2,
     xlim = c(0, 10)) 

legend("bottomleft", 
       legend = c("Underachiever", "Average", "Overachiever"), 
       col = c("#021636", "#bbceed", "#0a77f5"), 
       lwd = 2)

axis(1, lwd = 1)  # Change x-axis thickness
axis(2, lwd = 1)  # Change y-axis thickness

# Log Rank Test 
logrank_test$LDELTOTAL <- long_dat %>%
  filter(thirtile_res != 2) %>%
  survdiff(Surv(as.integer(VISCODE), LDELTOTAL_cut) ~ thirtile_res, data = .)
logrank_test$LDELTOTAL

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(LDELTOTAL_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(LDELTOTAL_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("#bbceed", "#021636"), labels = c("Normal Cognition", "Impaired Cognition")) +
  facet_wrap(~ thirtile_res, ncol = 3, 
             labeller = labeller(thirtile_res = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal() +
  theme(axis.line = element_line(size = 0.5),
        plot.title = element_text(hjust = 0.5, face = "bold")) +
  geom_vline(xintercept = 9, linetype = "dashed", color = "#940914")  # Add  vertical dashed line
```

## MOCA

Reference literature: doi: 10.1111/j.1532-5415.2005.53221.x

```{r, echo=FALSE, message=FALSE}
long_dat$MOCA_cut <- ifelse(long_dat$MOCA < 26, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), MOCA_cut) ~ thirtile_res, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, 
     main = "Kaplan-Meier Survival Curve", 
     xlab = "Time", 
     ylab = "Survival Probability", 
     col = c("#021636", "#bbceed", "#0a77f5"), 
     lwd = 2,
     xlim = c(0, 10)) 

legend("bottomleft", 
       legend = c("Underachiever", "Average", "Overachiever"), 
       col = c("#021636", "#bbceed", "#0a77f5"), 
       lwd = 2)

axis(1, lwd = 1)  # Change x-axis thickness
axis(2, lwd = 1)  # Change y-axis thickness

# Log Rank Test 
logrank_test$MOCA <- long_dat %>%
  filter(thirtile_res != 2) %>%
  survdiff(Surv(as.integer(VISCODE), MOCA_cut) ~ thirtile_res, data = .)
logrank_test$MOCA

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(MOCA_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(MOCA_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("#bbceed", "#021636"), labels = c("Normal Cognition", "Impaired Cognition")) +
  facet_wrap(~ thirtile_res, ncol = 3, 
             labeller = labeller(thirtile_res = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal() +
  theme(axis.line = element_line(size = 0.5),
        plot.title = element_text(hjust = 0.5, face = "bold")) +
  geom_vline(xintercept = 9, linetype = "dashed", color = "#940914")  # Add  vertical dashed line
```

## Rey-Auditory Verbal Learning Test (RAVLT)

The RAVLT was included as a measure of memory function. In this test, the participants are asked to recall words from a list of 15 nouns immediately after each of five learning trials and after a short and a long delay. Two measures known to be sensitive to cognitive changes in patients with AD were included in the present study: Immediate recall (RAVLT-Im): the number of correct responses across the immediate recall of the five learning trials; percent forgetting (RAVLT-PF): the score on the fifth learning trial minus the score on the long delayed recall, divided by the score obtained on the fifth learning trial. The lower the scores, the more severe impairment of cognitive function.

Different summary scores are derived from raw RAVLT scores. These include RAVLT Immediate (the sum of scores from 5 first trials (Trials 1 to 5)), RAVLT Learning (the score of Trial 5 minus the score of Trial 1), RAVLT Forgetting (the score of Trial 5 minus score of the delayed recall) and RAVLT Percent Forgetting (RAVLT Forgetting divided by the score of Trial 5). We use naming of the ADNI merge table3 for these summary measures. We investigated the relationship between MRI measures and RAVLT cognitive test scores by estimating the RAVLT Immediate and RAVLT Percent Forgetting from the gray matter density. These two summary scores were selected since they highlight different aspects of episodic memory, learning (RAVLT Immediate) and delayed memory (RAVLT Percent forgetting), essential to AD and previous studies (Estévez-González et al., 2003, Wang et al., 2011, Gomar et al., 2014, Moradi et al., 2015) have indicated strong relationships between these two RAVLT measures and Alzheimer's disease.

### RAVLT Immediate

```{r, echo=FALSE, message=FALSE}
cvalue$RAVLT_immediate <- wide_dat %>%
    filter(DX_0 == "CN") %>%
    summarize(
      value := mean(RAVLT_immediate_0, na.rm = TRUE) - 2 * sd(RAVLT_immediate_0, na.rm = TRUE)
    ) %>%
    pull(value)

long_dat$RAVLT_immediate_cut <- ifelse(long_dat$RAVLT_immediate > cvalue$RAVLT_immediate, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), RAVLT_immediate_cut) ~ thirtile_res, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, 
     main = "Kaplan-Meier Survival Curve", 
     xlab = "Time", 
     ylab = "Survival Probability", 
     col = c("#021636", "#bbceed", "#0a77f5"), 
     lwd = 2,
     xlim = c(0, 10)) 

legend("bottomleft", 
       legend = c("Underachiever", "Average", "Overachiever"), 
       col = c("#021636", "#bbceed", "#0a77f5"), 
       lwd = 2)

axis(1, lwd = 1)  # Change x-axis thickness
axis(2, lwd = 1)  # Change y-axis thickness

# Log Rank Test 
logrank_test$RAVLT_immediate <- long_dat %>%
  filter(thirtile_res != 2) %>%
  survdiff(Surv(as.integer(VISCODE), RAVLT_immediate_cut) ~ thirtile_res, data = .)
logrank_test$RAVLT_immediate

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(RAVLT_immediate_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(RAVLT_immediate_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("#bbceed", "#021636"), labels = c("Normal Cognition", "Impaired Cognition")) +
  facet_wrap(~ thirtile_res, ncol = 3, 
             labeller = labeller(thirtile_res = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal() +
  theme(axis.line = element_line(size = 0.5),
        plot.title = element_text(hjust = 0.5, face = "bold")) +
  geom_vline(xintercept = 9, linetype = "dashed", color = "#940914")  # Add  vertical dashed line
```

### RAVLT Percentage Forgetting

```{r, echo=FALSE, message=FALSE}
cvalue$RAVLT_perc_forgetting <- calculate_cvalue(RAVLT_perc_forgetting)

long_dat$RAVLT_perc_forgetting_cut <- ifelse(long_dat$RAVLT_perc_forgetting > cvalue$RAVLT_perc_forgetting, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), RAVLT_perc_forgetting_cut) ~ thirtile_res, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, 
     main = "Kaplan-Meier Survival Curve", 
     xlab = "Time", 
     ylab = "Survival Probability", 
     col = c("#021636", "#bbceed", "#0a77f5"), 
     lwd = 2,
     xlim = c(0, 10)) 

legend("bottomleft", 
       legend = c("Underachiever", "Average", "Overachiever"), 
       col = c("#021636", "#bbceed", "#0a77f5"), 
       lwd = 2)

axis(1, lwd = 1)  # Change x-axis thickness
axis(2, lwd = 1)  # Change y-axis thickness

# Log Rank Test 
logrank_test$RAVLT_perc_forgetting <- long_dat %>%
  filter(thirtile_res != 2) %>%
  survdiff(Surv(as.integer(VISCODE), RAVLT_perc_forgetting_cut) ~ thirtile_res, data = .)
logrank_test$RAVLT_perc_forgetting

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(RAVLT_perc_forgetting_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(RAVLT_perc_forgetting_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("#bbceed", "#021636"), labels = c("Normal Cognition", "Impaired Cognition")) +
  facet_wrap(~ thirtile_res, ncol = 3, 
             labeller = labeller(thirtile_res = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal() +
  theme(axis.line = element_line(size = 0.5),
        plot.title = element_text(hjust = 0.5, face = "bold")) +
  geom_vline(xintercept = 9, linetype = "dashed", color = "#940914")  # Add  vertical dashed line
```

### RAVLT Forgetting

```{r, echo=FALSE, message=FALSE}
cvalue$RAVLT_forgetting <- calculate_cvalue(RAVLT_forgetting)

long_dat$RAVLT_forgetting_cut <- ifelse(long_dat$RAVLT_forgetting > cvalue$RAVLT_forgetting, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), RAVLT_forgetting_cut) ~ thirtile_res, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, 
     main = "Kaplan-Meier Survival Curve", 
     xlab = "Time", 
     ylab = "Survival Probability", 
     col = c("#021636", "#bbceed", "#0a77f5"), 
     lwd = 2,
     xlim = c(0, 10)) 

legend("bottomleft", 
       legend = c("Underachiever", "Average", "Overachiever"), 
       col = c("#021636", "#bbceed", "#0a77f5"), 
       lwd = 2)

axis(1, lwd = 1)  # Change x-axis thickness
axis(2, lwd = 1)  # Change y-axis thickness

# Log Rank Test 
logrank_test$RAVLT_forgetting <- long_dat %>%
  filter(thirtile_res != 2) %>%
  survdiff(Surv(as.integer(VISCODE), RAVLT_forgetting_cut) ~ thirtile_res, data = .)
logrank_test$RAVLT_forgetting

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(RAVLT_forgetting_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(RAVLT_forgetting_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("#bbceed", "#021636"), labels = c("Normal Cognition", "Impaired Cognition")) +
  facet_wrap(~ thirtile_res, ncol = 3, 
             labeller = labeller(thirtile_res = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal() +
  theme(axis.line = element_line(size = 0.5),
        plot.title = element_text(hjust = 0.5, face = "bold")) +
  geom_vline(xintercept = 9, linetype = "dashed", color = "#940914")  # Add  vertical dashed line
```

### RAVLT Learning

```{r, echo=FALSE, message=FALSE}
cvalue$RAVLT_learning <- calculate_cvalue(RAVLT_learning)

long_dat$RAVLT_learning_cut <- ifelse(long_dat$RAVLT_learning > cvalue$RAVLT_learning, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), RAVLT_learning_cut) ~ thirtile_res, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, 
     main = "Kaplan-Meier Survival Curve", 
     xlab = "Time", 
     ylab = "Survival Probability", 
     col = c("#021636", "#bbceed", "#0a77f5"), 
     lwd = 2,
     xlim = c(0, 10)) 

legend("bottomleft", 
       legend = c("Underachiever", "Average", "Overachiever"), 
       col = c("#021636", "#bbceed", "#0a77f5"), 
       lwd = 2)

axis(1, lwd = 1)  # Change x-axis thickness
axis(2, lwd = 1)  # Change y-axis thickness

# Log Rank Test 
logrank_test$RAVLT_learning <- long_dat %>%
  filter(thirtile_res != 2) %>%
  survdiff(Surv(as.integer(VISCODE), RAVLT_learning_cut) ~ thirtile_res, data = .)
logrank_test$RAVLT_learning

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(RAVLT_learning_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(RAVLT_learning_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("#bbceed", "#021636"), labels = c("Normal Cognition", "Impaired Cognition")) +
  facet_wrap(~ thirtile_res, ncol = 3, 
             labeller = labeller(thirtile_res = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal() +
  theme(axis.line = element_line(size = 0.5),
        plot.title = element_text(hjust = 0.5, face = "bold")) +
  geom_vline(xintercept = 9, linetype = "dashed", color = "#940914")  # Add  vertical dashed line

```

## TRABSCORE

The Trail Making Test is a neuropsychological test of visual attention and task switching. It has two parts, in which the subject is instructed to connect a set of 25 dots as quickly as possible while maintaining accuracy.

The test can provide information about visual search speed, scanning, speed of processing, mental flexibility, and executive functioning. It is sensitive to cognitive impairment associated with dementia, including Alzheimer's disease. (ChatGPT)

Record the total number of seconds to complete Part B (*Trails B*), up to a maximum of 300 seconds. If the participant is not finished by 300 seconds, the score is 300.

```{r, echo=FALSE, message=FALSE}
cvalue$TRABSCOR <- calculate_cvalue(TRABSCOR)

long_dat$TRABSCOR_cut <- ifelse(long_dat$TRABSCOR > cvalue$TRABSCOR, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), TRABSCOR_cut) ~ thirtile_res, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, 
     main = "Kaplan-Meier Survival Curve", 
     xlab = "Time", 
     ylab = "Survival Probability", 
     col = c("#021636", "#bbceed", "#0a77f5"), 
     lwd = 2,
     xlim = c(0, 10)) 

legend("bottomleft", 
       legend = c("Underachiever", "Average", "Overachiever"), 
       col = c("#021636", "#bbceed", "#0a77f5"), 
       lwd = 2)

axis(1, lwd = 1)  # Change x-axis thickness
axis(2, lwd = 1)  # Change y-axis thickness

# Log Rank Test 
logrank_test$TRABSCOR <- long_dat %>%
  filter(thirtile_res != 2) %>%
  survdiff(Surv(as.integer(VISCODE), TRABSCOR_cut) ~ thirtile_res, data = .)
logrank_test$TRABSCOR

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(TRABSCOR_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(TRABSCOR_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("#bbceed", "#021636"), labels = c("Normal Cognition", "Impaired Cognition")) +
  facet_wrap(~ thirtile_res, ncol = 3, 
             labeller = labeller(thirtile_res = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal() +
  theme(axis.line = element_line(size = 0.5),
        plot.title = element_text(hjust = 0.5, face = "bold")) +
  geom_vline(xintercept = 9, linetype = "dashed", color = "#940914")  # Add  vertical dashed line
```

## Patient's Everyday Cognition (EcogPt)

The original version of the ECog is an informant-based measure of cognitively-relevant everyday abilities comprised of 39 items, covering six cognitively-relevant domains: Everyday Memory, Everyday Language, Everyday Visuospatial Abilities, and Everyday Planning, Everyday Organization, and Everyday Divided Attention. Ratings are made on a four-point scale: 1 = better or no change compared to 10 years earlier, 2 = questionable/occasionally worse, 3 = consistently a little worse, 4 = consistently much worse. ([Tomaszewski Farias et al., 2012](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3211103/))

### EcogPt Everyday Divided Attention

```{r, echo=FALSE, message=FALSE}
cvalue$EcogPtDivatt <- calculate_cvalue(EcogPtDivatt)

long_dat$EcogPtDivatt_cut <- ifelse(long_dat$EcogPtDivatt > cvalue$EcogPtDivatt, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), EcogPtDivatt_cut) ~ thirtile_res, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, 
     main = "Kaplan-Meier Survival Curve", 
     xlab = "Time", 
     ylab = "Survival Probability", 
     col = c("#021636", "#bbceed", "#0a77f5"), 
     lwd = 2,
     xlim = c(0, 10)) 

legend("bottomleft", 
       legend = c("Underachiever", "Average", "Overachiever"), 
       col = c("#021636", "#bbceed", "#0a77f5"), 
       lwd = 2)

axis(1, lwd = 1)  # Change x-axis thickness
axis(2, lwd = 1)  # Change y-axis thickness

# Log Rank Test 
logrank_test$EcogPtDivatt <- long_dat %>%
  filter(thirtile_res != 2) %>%
  survdiff(Surv(as.integer(VISCODE), EcogPtDivatt_cut) ~ thirtile_res, data = .)
logrank_test$EcogPtDivatt

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(EcogPtDivatt_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(EcogPtDivatt_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("#bbceed", "#021636"), labels = c("Normal Cognition", "Impaired Cognition")) +
  facet_wrap(~ thirtile_res, ncol = 3, 
             labeller = labeller(thirtile_res = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal() +
  theme(axis.line = element_line(size = 0.5),
        plot.title = element_text(hjust = 0.5, face = "bold")) +
  geom_vline(xintercept = 9, linetype = "dashed", color = "#940914")  # Add  vertical dashed line
```

### EcogPt Everyday Language

```{r, echo=FALSE}
cvalue$EcogPtLang <- calculate_cvalue(EcogPtLang)

long_dat$EcogPtLang_cut <- ifelse(long_dat$EcogPtLang > cvalue$EcogPtLang, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), EcogPtLang_cut) ~ thirtile_res, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, 
     main = "Kaplan-Meier Survival Curve", 
     xlab = "Time", 
     ylab = "Survival Probability", 
     col = c("#021636", "#bbceed", "#0a77f5"), 
     lwd = 2,
     xlim = c(0, 10)) 

legend("bottomleft", 
       legend = c("Underachiever", "Average", "Overachiever"), 
       col = c("#021636", "#bbceed", "#0a77f5"), 
       lwd = 2)

axis(1, lwd = 1)  # Change x-axis thickness
axis(2, lwd = 1)  # Change y-axis thickness

# Log Rank Test 
logrank_test$EcogPtLang <- long_dat %>%
  filter(thirtile_res != 2) %>%
  survdiff(Surv(as.integer(VISCODE), EcogPtLang_cut) ~ thirtile_res, data = .)
logrank_test$EcogPtLang

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(EcogPtLang_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(EcogPtLang_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("#bbceed", "#021636"), labels = c("Normal Cognition", "Impaired Cognition")) +
  facet_wrap(~ thirtile_res, ncol = 3, 
             labeller = labeller(thirtile_res = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal() +
  theme(axis.line = element_line(size = 0.5),
        plot.title = element_text(hjust = 0.5, face = "bold")) +
  geom_vline(xintercept = 9, linetype = "dashed", color = "#940914")  # Add  vertical dashed line
```

### EcogPt Everyday Memory

```{r, echo=FALSE}
cvalue$EcogPtMem <- calculate_cvalue(EcogPtMem)

long_dat$EcogPtMem_cut <- ifelse(long_dat$EcogPtMem > cvalue$EcogPtMem, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), EcogPtMem_cut) ~ thirtile_res, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, 
     main = "Kaplan-Meier Survival Curve", 
     xlab = "Time", 
     ylab = "Survival Probability", 
     col = c("#021636", "#bbceed", "#0a77f5"), 
     lwd = 2,
     xlim = c(0, 10)) 

legend("bottomleft", 
       legend = c("Underachiever", "Average", "Overachiever"), 
       col = c("#021636", "#bbceed", "#0a77f5"), 
       lwd = 2)

axis(1, lwd = 1)  # Change x-axis thickness
axis(2, lwd = 1)  # Change y-axis thickness

# Log Rank Test 
logrank_test$EcogPtMem <- long_dat %>%
  filter(thirtile_res != 2) %>%
  survdiff(Surv(as.integer(VISCODE), EcogPtMem_cut) ~ thirtile_res, data = .)
logrank_test$EcogPtMem

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(EcogPtMem_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(EcogPtMem_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("#bbceed", "#021636"), labels = c("Normal Cognition", "Impaired Cognition")) +
  facet_wrap(~ thirtile_res, ncol = 3, 
             labeller = labeller(thirtile_res = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal() +
  theme(axis.line = element_line(size = 0.5),
        plot.title = element_text(hjust = 0.5, face = "bold")) +
  geom_vline(xintercept = 9, linetype = "dashed", color = "#940914")  # Add  vertical dashed line
```

### EcogPt Everyday Organization

```{r, echo=FALSE}
cvalue$EcogPtOrgan <- calculate_cvalue(EcogPtOrgan)

long_dat$EcogPtOrgan_cut <- ifelse(long_dat$EcogPtOrgan > cvalue$EcogPtOrgan, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), EcogPtOrgan_cut) ~ thirtile_res, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, 
     main = "Kaplan-Meier Survival Curve", 
     xlab = "Time", 
     ylab = "Survival Probability", 
     col = c("#021636", "#bbceed", "#0a77f5"), 
     lwd = 2,
     xlim = c(0, 10)) 

legend("bottomleft", 
       legend = c("Underachiever", "Average", "Overachiever"), 
       col = c("#021636", "#bbceed", "#0a77f5"), 
       lwd = 2)

axis(1, lwd = 1)  # Change x-axis thickness
axis(2, lwd = 1)  # Change y-axis thickness

# Log Rank Test 
logrank_test$EcogPtOrgan <- long_dat %>%
  filter(thirtile_res != 2) %>%
  survdiff(Surv(as.integer(VISCODE), EcogPtOrgan_cut) ~ thirtile_res, data = .)
logrank_test$EcogPtOrgan

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(EcogPtOrgan_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(EcogPtOrgan_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("#bbceed", "#021636"), labels = c("Normal Cognition", "Impaired Cognition")) +
  facet_wrap(~ thirtile_res, ncol = 3, 
             labeller = labeller(thirtile_res = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal() +
  theme(axis.line = element_line(size = 0.5),
        plot.title = element_text(hjust = 0.5, face = "bold")) +
  geom_vline(xintercept = 9, linetype = "dashed", color = "#940914")  # Add  vertical dashed line
```

### EcogPt Everyday Planning

```{r, echo=FALSE}
cvalue$EcogPtPlan <- calculate_cvalue(EcogPtPlan)

long_dat$EcogPtPlan_cut <- ifelse(long_dat$EcogPtPlan > cvalue$EcogPtPlan, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), EcogPtPlan_cut) ~ thirtile_res, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, 
     main = "Kaplan-Meier Survival Curve", 
     xlab = "Time", 
     ylab = "Survival Probability", 
     col = c("#021636", "#bbceed", "#0a77f5"), 
     lwd = 2,
     xlim = c(0, 10)) 

legend("bottomleft", 
       legend = c("Underachiever", "Average", "Overachiever"), 
       col = c("#021636", "#bbceed", "#0a77f5"), 
       lwd = 2)

axis(1, lwd = 1)  # Change x-axis thickness
axis(2, lwd = 1)  # Change y-axis thickness

# Log Rank Test 
logrank_test$EcogPtPlan <- long_dat %>%
  filter(thirtile_res != 2) %>%
  survdiff(Surv(as.integer(VISCODE), EcogPtPlan_cut) ~ thirtile_res, data = .)
logrank_test$EcogPtPlan

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(EcogPtPlan_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(EcogPtPlan_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("#bbceed", "#021636"), labels = c("Normal Cognition", "Impaired Cognition")) +
  facet_wrap(~ thirtile_res, ncol = 3, 
             labeller = labeller(thirtile_res = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal() +
  theme(axis.line = element_line(size = 0.5),
        plot.title = element_text(hjust = 0.5, face = "bold")) +
  geom_vline(xintercept = 9, linetype = "dashed", color = "#940914")  # Add  vertical dashed line
```

### EcogPt Everyday Visuospatial Abilities

```{r, echo=FALSE}
cvalue$EcogPtVisspat <- calculate_cvalue(EcogPtVisspat)

long_dat$EcogPtVisspat_cut <- ifelse(long_dat$EcogPtVisspat > cvalue$EcogPtVisspat, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), EcogPtVisspat_cut) ~ thirtile_res, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, 
     main = "Kaplan-Meier Survival Curve", 
     xlab = "Time", 
     ylab = "Survival Probability", 
     col = c("#021636", "#bbceed", "#0a77f5"), 
     lwd = 2,
     xlim = c(0, 10)) 

legend("bottomleft", 
       legend = c("Underachiever", "Average", "Overachiever"), 
       col = c("#021636", "#bbceed", "#0a77f5"), 
       lwd = 2)

axis(1, lwd = 1)  # Change x-axis thickness
axis(2, lwd = 1)  # Change y-axis thickness

# Log Rank Test 
logrank_test$EcogPtVisspat <- long_dat %>%
  filter(thirtile_res != 2) %>%
  survdiff(Surv(as.integer(VISCODE), EcogPtVisspat_cut) ~ thirtile_res, data = .)
logrank_test$EcogPtVisspat

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(EcogPtVisspat_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(EcogPtVisspat_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("#bbceed", "#021636"), labels = c("Normal Cognition", "Impaired Cognition")) +
  facet_wrap(~ thirtile_res, ncol = 3, 
             labeller = labeller(thirtile_res = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal() +
  theme(axis.line = element_line(size = 0.5),
        plot.title = element_text(hjust = 0.5, face = "bold")) +
  geom_vline(xintercept = 9, linetype = "dashed", color = "#940914")  # Add  vertical dashed line
```

### EcogPt Total ???

```{r, echo=FALSE}
cvalue$EcogPtTotal <- calculate_cvalue(EcogPtTotal)

long_dat$EcogPtTotal_cut <- ifelse(long_dat$EcogPtTotal > cvalue$EcogPtTotal, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), EcogPtTotal_cut) ~ thirtile_res, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, 
     main = "Kaplan-Meier Survival Curve", 
     xlab = "Time", 
     ylab = "Survival Probability", 
     col = c("#021636", "#bbceed", "#0a77f5"), 
     lwd = 2,
     xlim = c(0, 10)) 

legend("bottomleft", 
       legend = c("Underachiever", "Average", "Overachiever"), 
       col = c("#021636", "#bbceed", "#0a77f5"), 
       lwd = 2)

axis(1, lwd = 1)  # Change x-axis thickness
axis(2, lwd = 1)  # Change y-axis thickness

# Log Rank Test 
logrank_test$EcogPtTotal <- long_dat %>%
  filter(thirtile_res != 2) %>%
  survdiff(Surv(as.integer(VISCODE), EcogPtTotal_cut) ~ thirtile_res, data = .)
logrank_test$EcogPtTotal

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(EcogPtTotal_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(EcogPtTotal_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("#bbceed", "#021636"), labels = c("Normal Cognition", "Impaired Cognition")) +
  facet_wrap(~ thirtile_res, ncol = 3, 
             labeller = labeller(thirtile_res = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal() +
  theme(axis.line = element_line(size = 0.5),
        plot.title = element_text(hjust = 0.5, face = "bold")) +
  geom_vline(xintercept = 9, linetype = "dashed", color = "#940914")  # Add  vertical dashed line
```

## Self-Reported Everyday Cognitive Abilities Questionnaire (EcogSP)

### EcogSP Everyday Divided Attention

```{r, echo=FALSE}
cvalue$EcogSPDivatt <- calculate_cvalue(EcogSPDivatt)

long_dat$EcogSPDivatt_cut <- ifelse(long_dat$EcogSPDivatt > cvalue$EcogSPDivatt, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), EcogSPDivatt_cut) ~ thirtile_res, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, 
     main = "Kaplan-Meier Survival Curve", 
     xlab = "Time", 
     ylab = "Survival Probability", 
     col = c("#021636", "#bbceed", "#0a77f5"), 
     lwd = 2,
     xlim = c(0, 10)) 

legend("bottomleft", 
       legend = c("Underachiever", "Average", "Overachiever"), 
       col = c("#021636", "#bbceed", "#0a77f5"), 
       lwd = 2)

axis(1, lwd = 1)  # Change x-axis thickness
axis(2, lwd = 1)  # Change y-axis thickness

# Log Rank Test 
logrank_test$EcogSPDivatt <- long_dat %>%
  filter(thirtile_res != 2) %>%
  survdiff(Surv(as.integer(VISCODE), EcogSPDivatt_cut) ~ thirtile_res, data = .)
logrank_test$EcogSPDivatt

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(EcogSPDivatt_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(EcogSPDivatt_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("#bbceed", "#021636"), labels = c("Normal Cognition", "Impaired Cognition")) +
  facet_wrap(~ thirtile_res, ncol = 3, 
             labeller = labeller(thirtile_res = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal() +
  theme(axis.line = element_line(size = 0.5),
        plot.title = element_text(hjust = 0.5, face = "bold")) +
  geom_vline(xintercept = 9, linetype = "dashed", color = "#940914")  # Add  vertical dashed line
```

### EcogSP Everyday Language

```{r, echo=FALSE}
cvalue$EcogSPLang <- calculate_cvalue(EcogSPLang)

long_dat$EcogSPLang_cut <- ifelse(long_dat$EcogSPLang > cvalue$EcogSPLang, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), EcogSPLang_cut) ~ thirtile_res, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, 
     main = "Kaplan-Meier Survival Curve", 
     xlab = "Time", 
     ylab = "Survival Probability", 
     col = c("#021636", "#bbceed", "#0a77f5"), 
     lwd = 2,
     xlim = c(0, 10)) 

legend("bottomleft", 
       legend = c("Underachiever", "Average", "Overachiever"), 
       col = c("#021636", "#bbceed", "#0a77f5"), 
       lwd = 2)

axis(1, lwd = 1)  # Change x-axis thickness
axis(2, lwd = 1)  # Change y-axis thickness

# Log Rank Test 
logrank_test$EcogSPLang <- long_dat %>%
  filter(thirtile_res != 2) %>%
  survdiff(Surv(as.integer(VISCODE), EcogSPLang_cut) ~ thirtile_res, data = .)
logrank_test$EcogSPLang

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(EcogSPLang_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(EcogSPLang_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("#bbceed", "#021636"), labels = c("Normal Cognition", "Impaired Cognition")) +
  facet_wrap(~ thirtile_res, ncol = 3, 
             labeller = labeller(thirtile_res = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal() +
  theme(axis.line = element_line(size = 0.5),
        plot.title = element_text(hjust = 0.5, face = "bold")) +
  geom_vline(xintercept = 9, linetype = "dashed", color = "#940914")  # Add  vertical dashed line
```

### EcogSP Everyday Memory

```{r, echo=FALSE}
cvalue$EcogSPMem <- calculate_cvalue(EcogSPMem)

long_dat$EcogSPMem_cut <- ifelse(long_dat$EcogSPMem > cvalue$EcogSPMem, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), EcogSPMem_cut) ~ thirtile_res, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, 
     main = "Kaplan-Meier Survival Curve", 
     xlab = "Time", 
     ylab = "Survival Probability", 
     col = c("#021636", "#bbceed", "#0a77f5"), 
     lwd = 2,
     xlim = c(0, 10)) 

legend("bottomleft", 
       legend = c("Underachiever", "Average", "Overachiever"), 
       col = c("#021636", "#bbceed", "#0a77f5"), 
       lwd = 2)

axis(1, lwd = 1)  # Change x-axis thickness
axis(2, lwd = 1)  # Change y-axis thickness

# Log Rank Test 
logrank_test$EcogSPMem <- long_dat %>%
  filter(thirtile_res != 2) %>%
  survdiff(Surv(as.integer(VISCODE), EcogSPMem_cut) ~ thirtile_res, data = .)
logrank_test$EcogSPMem

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(EcogSPMem_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(EcogSPMem_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("#bbceed", "#021636"), labels = c("Normal Cognition", "Impaired Cognition")) +
  facet_wrap(~ thirtile_res, ncol = 3, 
             labeller = labeller(thirtile_res = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal() +
  theme(axis.line = element_line(size = 0.5),
        plot.title = element_text(hjust = 0.5, face = "bold")) +
  geom_vline(xintercept = 9, linetype = "dashed", color = "#940914")  # Add  vertical dashed line
```

### EcogSP Everyday Organization

```{r, echo=FALSE}
cvalue$EcogSPOrgan <- calculate_cvalue(EcogSPOrgan)

long_dat$EcogSPOrgan_cut <- ifelse(long_dat$EcogSPOrgan > cvalue$EcogSPOrgan, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), EcogSPOrgan_cut) ~ thirtile_res, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, 
     main = "Kaplan-Meier Survival Curve", 
     xlab = "Time", 
     ylab = "Survival Probability", 
     col = c("#021636", "#bbceed", "#0a77f5"), 
     lwd = 2,
     xlim = c(0, 10)) 

legend("bottomleft", 
       legend = c("Underachiever", "Average", "Overachiever"), 
       col = c("#021636", "#bbceed", "#0a77f5"), 
       lwd = 2)

axis(1, lwd = 1)  # Change x-axis thickness
axis(2, lwd = 1)  # Change y-axis thickness

# Log Rank Test 
logrank_test$EcogSPOrgan <- long_dat %>%
  filter(thirtile_res != 2) %>%
  survdiff(Surv(as.integer(VISCODE), EcogSPOrgan_cut) ~ thirtile_res, data = .)
logrank_test$EcogSPOrgan

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(EcogSPOrgan_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(EcogSPOrgan_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("#bbceed", "#021636"), labels = c("Normal Cognition", "Impaired Cognition")) +
  facet_wrap(~ thirtile_res, ncol = 3, 
             labeller = labeller(thirtile_res = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal() +
  theme(axis.line = element_line(size = 0.5),
        plot.title = element_text(hjust = 0.5, face = "bold")) +
  geom_vline(xintercept = 9, linetype = "dashed", color = "#940914")  # Add  vertical dashed line
```

### EcogSP Everyday Planning

```{r, echo=FALSE}
cvalue$EcogSPPlan <- calculate_cvalue(EcogSPPlan)

long_dat$EcogSPPlan_cut <- ifelse(long_dat$EcogSPPlan > cvalue$EcogSPPlan, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), EcogSPPlan_cut) ~ thirtile_res, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, 
     main = "Kaplan-Meier Survival Curve", 
     xlab = "Time", 
     ylab = "Survival Probability", 
     col = c("#021636", "#bbceed", "#0a77f5"), 
     lwd = 2,
     xlim = c(0, 10)) 

legend("bottomleft", 
       legend = c("Underachiever", "Average", "Overachiever"), 
       col = c("#021636", "#bbceed", "#0a77f5"), 
       lwd = 2)

axis(1, lwd = 1)  # Change x-axis thickness
axis(2, lwd = 1)  # Change y-axis thickness

# Log Rank Test 
logrank_test$EcogSPPlan <- long_dat %>%
  filter(thirtile_res != 2) %>%
  survdiff(Surv(as.integer(VISCODE), EcogSPPlan_cut) ~ thirtile_res, data = .)
logrank_test$EcogSPPlan

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(EcogSPPlan_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(EcogSPPlan_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("#bbceed", "#021636"), labels = c("Normal Cognition", "Impaired Cognition")) +
  facet_wrap(~ thirtile_res, ncol = 3, 
             labeller = labeller(thirtile_res = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal() +
  theme(axis.line = element_line(size = 0.5),
        plot.title = element_text(hjust = 0.5, face = "bold")) +
  geom_vline(xintercept = 9, linetype = "dashed", color = "#940914")  # Add  vertical dashed line
```

### EcogSP Everyday Visuospatial Abilities

```{r, echo=FALSE, message=FALSE}
cvalue$EcogSPVisspat <- calculate_cvalue(EcogSPVisspat)

long_dat$EcogSPVisspat_cut <- ifelse(long_dat$EcogSPVisspat > cvalue$EcogSPVisspat, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), EcogSPVisspat_cut) ~ thirtile_res, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, 
     main = "Kaplan-Meier Survival Curve", 
     xlab = "Time", 
     ylab = "Survival Probability", 
     col = c("#021636", "#bbceed", "#0a77f5"), 
     lwd = 2,
     xlim = c(0, 10)) 

legend("bottomleft", 
       legend = c("Underachiever", "Average", "Overachiever"), 
       col = c("#021636", "#bbceed", "#0a77f5"), 
       lwd = 2)

axis(1, lwd = 1)  # Change x-axis thickness
axis(2, lwd = 1)  # Change y-axis thickness

# Log Rank Test 
logrank_test$EcogSPVisspat <- long_dat %>%
  filter(thirtile_res != 2) %>%
  survdiff(Surv(as.integer(VISCODE), EcogSPVisspat_cut) ~ thirtile_res, data = .)
logrank_test$EcogSPVisspat

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(EcogSPVisspat_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(EcogSPVisspat_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("#bbceed", "#021636"), labels = c("Normal Cognition", "Impaired Cognition")) +
  facet_wrap(~ thirtile_res, ncol = 3, 
             labeller = labeller(thirtile_res = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal() +
  theme(axis.line = element_line(size = 0.5),
        plot.title = element_text(hjust = 0.5, face = "bold")) +
  geom_vline(xintercept = 9, linetype = "dashed", color = "#940914")  # Add  vertical dashed line
```

### EcogSP Total ???

```{r, echo=FALSE}
cvalue$EcogSPTotal <- calculate_cvalue(EcogSPTotal)

long_dat$EcogSPTotal_cut <- ifelse(long_dat$EcogSPTotal > cvalue$EcogSPTotal, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), EcogSPTotal_cut) ~ thirtile_res, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, 
     main = "Kaplan-Meier Survival Curve", 
     xlab = "Time", 
     ylab = "Survival Probability", 
     col = c("#021636", "#bbceed", "#0a77f5"), 
     lwd = 2,
     xlim = c(0, 10)) 

legend("bottomleft", 
       legend = c("Underachiever", "Average", "Overachiever"), 
       col = c("#021636", "#bbceed", "#0a77f5"), 
       lwd = 2)

axis(1, lwd = 1)  # Change x-axis thickness
axis(2, lwd = 1)  # Change y-axis thickness

# Log Rank Test 
logrank_test$EcogSPTotal <- long_dat %>%
  filter(thirtile_res != 2) %>%
  survdiff(Surv(as.integer(VISCODE), EcogSPTotal_cut) ~ thirtile_res, data = .)
logrank_test$EcogSPTotal

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(EcogSPTotal_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(EcogSPTotal_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("#bbceed", "#021636"), labels = c("Normal Cognition", "Impaired Cognition")) +
  facet_wrap(~ thirtile_res, ncol = 3, 
             labeller = labeller(thirtile_res = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal() +
  theme(axis.line = element_line(size = 0.5),
        plot.title = element_text(hjust = 0.5, face = "bold")) +
  geom_vline(xintercept = 9, linetype = "dashed", color = "#940914")  # Add  vertical dashed line
```

```{r}
test <- long_dat %>% filter(AGE %in% 60:70)

# also test # people 65 to 75

```
