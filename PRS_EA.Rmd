---
title: "PRS_EA"
output: html_document
author: Sebastian Marten & Amaury Pelzer
---

```{r, include=FALSE}
if (suppressWarnings(!require(tidyverse))) {install.packages("tidyverse"); library(tidyverse)}
if (suppressWarnings(!require(ggplot2))) {install.packages("ggplot2"); library(ggplot2)}
if (suppressWarnings(!require(data.table))) {install.packages("data.table"); library(data.table)}
if (suppressWarnings(!require(formattable))) {install.packages("formattable"); library(formattable)}
if (suppressWarnings(!require(survival))) {install.packages("survival"); library(survival)}
if (suppressWarnings(!require(ggsurvfit))) {install.packages("ggsurvfit"); library(ggsurvfit)}
```

# Data Preprocessing

1.  First, I wanted to investigate which variables are time dependent and also exclude some that were clearly unnecessary (i.e., "SITE","COLPROT","ORIGPROT", "FLDSTRENG","FSVERSION","IMAGEUID", "Month_bl","Month","M","update_stamp").

```{r, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)

dat <- read.csv("data/ADNIMERGE.csv")

time_test <- function(data, idvar, tvar) {
  x <- data[, c(idvar, tvar)] %>% arrange(tvar)
  time_dependent <- FALSE
  unique_participants <- unique(x[, 1])
  for (participant in unique_participants) {
    participant_data <- x[x[, 1] == participant, 2]
    if (length(unique(participant_data)) > 1) {
      time_dependent <- TRUE
      break
    }
  }
  if (time_dependent) {
    return(data.frame(variable = tvar, status = "Time Dependent"))
  } else {
    return(data.frame(variable = tvar, status = "Time Independent"))
  }
}

results <- data.frame(variable = character(), status = character(), stringsAsFactors = FALSE)

for (col in 1:length(colnames(dat))) {
  result <- time_test(dat, "RID", colnames(dat)[col])
  results <- rbind(results, result)
}


excluded_vars <- c("SITE","COLPROT","ORIGPROT","FLDSTRENG",
                   "FSVERSION","IMAGEUID", "Month_bl","Month","M",
                   "update_stamp", "FSVERSION_bl", "FLDSTRENG_bl", 
                   "EXAMDATE_bl", "EXAMDATE", "Years_bl")

ivars <- subset(results, status=="Time Independent") %>%
  subset(!(variable %in% excluded_vars)) %>% subset(select=variable)

nivars <- subset(results, status=="Time Dependent") %>% 
  subset(!(variable %in% excluded_vars)) %>% subset(select=variable)

rm(results, result, col)
```

2.  Merge time dependent and independent variables into the long_dat data frame. Also, I recoded the time points in the VISCODE variable into integers.

```{r}
long_dat <- dat[, c(ivars[,1], nivars[,1])] %>%
  mutate(VISCODE = match(VISCODE, c("bl", "m03", "m06", "m12", "m18", "m24", 
                                    "m30","m36", "m42", "m48", "m54", "m60", 
                                    "m66", "m72","m78", "m84", "m90", "m96", 
                                    "m102", "m108","m114", "m120", "m126", 
                                    "m132", "m144", "m156"))-1) %>%
  relocate(RID, PTID, VISCODE) %>%
  arrange(RID, VISCODE)
```

3.  In the original data frame there were quite some \_bl or \_BL variables. Thus, I wanted to check whether these columns had already been integrated or not at each corresponding time point for each participant. Surprise, the test was negative.

```{r, include= FALSE}
baseline_vars <- long_dat %>%
  select(c("VISCODE","PTID",ends_with("_bl"),ends_with("_BL"))) %>%
  filter(VISCODE == 0) %>%
  subset(select = -c(DX_bl, VISCODE)) %>%
  rename(LDELTOTAL_bl = LDELTOTAL_BL)

baseline_commplementary_vars <- long_dat %>% 
  
  subset(select = c(VISCODE, DX, CDRSB, ADAS11, ADAS13, ADASQ4,MMSE,
  RAVLT_immediate,RAVLT_learning,RAVLT_forgetting,RAVLT_perc_forgetting,
  LDELTOTAL,DIGITSCOR,TRABSCOR,FAQ,mPACCdigit,mPACCtrailsB,Ventricles,
  Hippocampus,WholeBrain,Entorhinal,Fusiform,MidTemp,ICV,MOCA,EcogPtMem,
  EcogPtLang,EcogPtVisspat,EcogPtPlan,EcogPtOrgan,EcogPtDivatt,EcogPtTotal,
  EcogSPMem,EcogSPLang,EcogSPVisspat,EcogSPPlan,EcogSPOrgan,EcogSPDivatt,
  EcogSPTotal,ABETA,TAU,PTAU,FDG,PIB,AV45)) %>%
  
  filter(VISCODE == 0) %>% 
  subset(select = -c(DX, VISCODE))

length(colnames(baseline_vars)) == length(colnames(baseline_commplementary_vars))
all.equal(baseline_vars, baseline_commplementary_vars)
```

4.  Therefore, I continued with merging the \_bl/\_BL variables with the corresponding time dependent variable for each participant. Additionally, I specified the data type of each variable individually for optimal control and oversight over the data structure.

```{r, include= FALSE}
baseline_commplementary_col_names <- colnames(baseline_commplementary_vars)

long_dat <- long_dat %>%
  left_join(baseline_vars, by = "PTID", suffix = c("", "_bl")) %>%
  mutate(across(all_of(baseline_commplementary_col_names), ~ coalesce(., get(paste0(cur_column(), "_bl"))))) %>%
  select(-ends_with("_bl"), -ends_with("_BL")) %>%
  mutate(
    RID = as.factor(RID),
    PTID = as.character(PTID),
    VISCODE = as.factor(VISCODE),
    AGE = as.numeric(AGE),
    PTGENDER = as.factor(PTGENDER),
    PTEDUCAT = as.integer(PTEDUCAT),
    PTETHCAT = as.factor(PTETHCAT),
    PTRACCAT = as.factor(PTRACCAT),
    PTMARRY = as.factor(PTMARRY),
    APOE4 = as.integer(APOE4),
    FDG = as.numeric(FDG),
    PIB = as.numeric(PIB),
    AV45 = as.numeric(AV45),
    ABETA = as.numeric(ABETA),
    TAU = as.numeric(TAU),
    PTAU = as.numeric(PTAU),
    CDRSB = as.numeric(CDRSB),
    ADAS11 = as.numeric(ADAS11),
    ADAS13 = as.numeric(ADAS13),
    ADASQ4 = as.integer(ADASQ4),
    MMSE = as.integer(MMSE),
    RAVLT_immediate = as.integer(RAVLT_immediate),
    RAVLT_learning = as.integer(RAVLT_learning),
    RAVLT_forgetting = as.integer(RAVLT_forgetting),
    RAVLT_perc_forgetting = as.numeric(RAVLT_perc_forgetting),
    LDELTOTAL = as.integer(LDELTOTAL),
    DIGITSCOR = as.integer(DIGITSCOR),
    TRABSCOR = as.integer(TRABSCOR),
    FAQ = as.integer(FAQ),
    MOCA = as.integer(MOCA),
    EcogPtMem = as.numeric(EcogPtMem),
    EcogPtLang = as.numeric(EcogPtLang),
    EcogPtVisspat = as.numeric(EcogPtVisspat),
    EcogPtPlan = as.numeric(EcogPtPlan),
    EcogPtOrgan = as.numeric(EcogPtOrgan),
    EcogPtDivatt = as.numeric(EcogPtDivatt),
    EcogPtTotal = as.numeric(EcogPtTotal),
    EcogSPMem = as.numeric(EcogSPMem),
    EcogSPLang = as.numeric(EcogSPLang),
    EcogSPVisspat = as.numeric(EcogSPVisspat),
    EcogSPPlan = as.numeric(EcogSPPlan),
    EcogSPOrgan = as.numeric(EcogSPOrgan),
    EcogSPDivatt = as.numeric(EcogSPDivatt),
    EcogSPTotal = as.numeric(EcogSPTotal),
    Ventricles = as.integer(Ventricles),
    Hippocampus = as.integer(Hippocampus),
    WholeBrain = as.integer(WholeBrain),
    Entorhinal = as.integer(Entorhinal),
    Fusiform = as.integer(Fusiform),
    MidTemp = as.integer(MidTemp),
    ICV = as.integer(ICV),
    DX = as.factor(DX),
    mPACCdigit = as.numeric(mPACCdigit),
    mPACCtrailsB = as.numeric(mPACCtrailsB)
    )
```

5.  Transform Long to Wide Data Format

```{r, echo=FALSE}
ivars <- ivars %>% filter(!str_detect(variable, "_bl|_BL") & variable != "DX_bl") %>%
  pull(variable) %>%
  as.character()

nivars <- nivars %>% 
  filter(! str_detect(variable, "VISCODE")) %>%
  pull(variable) %>%
  as.character()

wide_dat <- pivot_wider(
  long_dat,
  id_cols = all_of(ivars),
  names_from = "VISCODE",
  values_from = all_of(nivars),
  values_fn = list(n = n_distinct),
  names_sep = "_"
  )

head(wide_dat)
```

# Attrition Analysis

Based on the number of participants measured at any time point I made a frequency plot to get a first idea of the sampling frequency.

```{r, echo=FALSE, fig.align="center"}
frequency_table <- long_dat %>%
  group_by(VISCODE) %>%
  summarise(NumParticipants = n_distinct(RID))

barplot(frequency_table$NumParticipants~frequency_table$VISCODE, xlab="Time", ylab="Number of Patients Measured",
     main="Attrition Plot")
```

# Domains

## Demographics

```{r, echo=FALSE}
df_demographics <- long_dat %>%
  select(RID, PTID, VISCODE, AGE, PTGENDER, PTEDUCAT, PTETHCAT, PTRACCAT, PTMARRY)

freq_dem <- df_demographics %>%
  group_by(VISCODE) %>%
  summarise(across(everything(), ~ sum(!is.na(.))))

freq_dem_long <- pivot_longer(freq_dem, cols = -VISCODE, names_to = "Variable", values_to = "Frequency")

ggplot(freq_dem_long, aes(x = VISCODE, y = Frequency, color = Variable, group = Variable)) +
  geom_line() +
  labs(x = "Timepoint (VISCODE)", y = "Number of Measurements", title = "Number of Measurements per Time Point") +
  theme(legend.position = "top")
```

## Cognitive Tests

```{r, echo=FALSE}
df_cognitive_tests <- long_dat %>%
  select(RID, PTID, VISCODE, CDRSB, ADAS11, ADAS13, ADASQ4, MMSE,
         RAVLT_immediate, RAVLT_learning, RAVLT_forgetting, RAVLT_perc_forgetting,
         LDELTOTAL, DIGITSCOR, TRABSCOR, FAQ, MOCA,
         EcogPtMem, EcogPtLang, EcogPtVisspat, EcogPtPlan, EcogPtOrgan, EcogPtDivatt, EcogPtTotal,
         EcogSPMem, EcogSPLang, EcogSPVisspat, EcogSPPlan, EcogSPOrgan, EcogSPDivatt, EcogSPTotal)

freq_cog <- df_cognitive_tests %>%
  group_by(VISCODE) %>%
  summarise(across(everything(), ~ sum(!is.na(.))))

freq_cog_long <- pivot_longer(freq_cog, cols = -VISCODE, names_to = "Variable", values_to = "Frequency")

ggplot(freq_cog_long, aes(x = VISCODE, y = Frequency, color = Variable, group = Variable)) +
  geom_line() +
  labs(x = "Timepoint (VISCODE)", y = "Number of Measurements", title = "Number of Measurements per Time Point") +
  theme(legend.position = "top")
```

## Biomedical Imaging

```{r,echo=FALSE}
df_biomedical_imaging <- long_dat %>%
  select(RID, PTID, VISCODE, Ventricles, Hippocampus, WholeBrain, Entorhinal, Fusiform, MidTemp, ICV)

freq_imag <- df_biomedical_imaging %>%
  group_by(VISCODE) %>%
  summarise(across(everything(), ~ sum(!is.na(.))))

freq_imag_long <- pivot_longer(freq_imag, cols = -VISCODE, names_to = "Variable", values_to = "Frequency")

ggplot(freq_imag_long, aes(x = VISCODE, y = Frequency, color = Variable, group = Variable)) +
  geom_line() +
  labs(x = "Timepoint (VISCODE)", y = "Number of Measurements", title = "Number of Measurements per Time Point") +
  theme(legend.position = "top")
```

## Biomarkers

```{r, echo=FALSE}
df_biomarkers <- long_dat %>%
  select(RID, PTID, VISCODE, APOE4, ABETA, TAU, PTAU, FDG, PIB, AV45)

freq_mark <- df_biomarkers %>%
  group_by(VISCODE) %>%
  summarise(across(everything(), ~ sum(!is.na(.))))

freq_mark_long <- pivot_longer(freq_mark, cols = -VISCODE, names_to = "Variable", values_to = "Frequency")

ggplot(freq_mark_long, aes(x = VISCODE, y = Frequency, color = Variable, group = Variable)) +
  geom_line() +
  labs(x = "Timepoint (VISCODE)", y = "Number of Measurements", title = "Number of Measurements per Time Point") +
  theme(legend.position = "top")
```

Based on these findings it appears that time point 9 is a cut-off where the number of measurements drop quite strongly. Time point 9 corresponds to month 42 (i.e., 3.5 years) of the follow-up.

```{r, echo=FALSE}
rm(list= setdiff(ls(), c("long_dat", "wide_dat")))
```

# Polygenic Risk Score for Educational attainment

```{r, echo=FALSE, message=FALSE}
# Read in the PGS send to us by Rick
pgs <- readr::read_tsv("data/ADNI_PRS_results_EA_EA22.tsv")

# Merge the EA data with the corresponding participant in each data frame
long_dat <- merge(long_dat, pgs,by.x="PTID",by.y="SampleID") 
wide_dat <- merge(wide_dat, pgs,by.x="PTID",by.y="SampleID")
```

The merge(by.x, by.y) function creates a new data frame that only keeps those rows for which there is a matching key (in our case PTID). Therefore, we do have genetic data from 2 additional individuals for which we do not have any other measurements. The final data frame for which testing data and genetic data is available is thus, 1408 (N).

## Plot PGS EA vs. Actual EA

Based on this plot, we can see a positive relationship between the polygenic score for education attainment and actual years of education. This means that with a higher PGS score comes higher genetic capacity for educational attainment.

We ran Pearson's correlation which resulted in r = 0.286 (p-value < 2.2e-16)

```{r, echo=FALSE, message=FALSE, results='hide'}
# Plot PGS EA against Actual EA
ggplot(long_dat, aes(x = PTEDUCAT, y = EA22)) +
  geom_point() +  # Add points
  geom_smooth(method = "lm") +  # Add linear regression line
  labs(x = "Years of Education", y = "EA22") +  # Set axis labels
  ggtitle("EA22 vs Years of Education")  # Set plot title

cor(long_dat$PTEDUCAT, long_dat$EA22, method="pearson")
cor.test(long_dat$PTEDUCAT, long_dat$EA22, method="pearson")
```

## Create Residuals

To get the residual we regressed the polygenic risk score for educational attainment
against actual EA including the variables SEX & AGE as covariates. The results are depicted in the density plot.

```{r, echo=FALSE}
# Create the residuals given two covariates AGE and Sex
results <- lm(PTEDUCAT~EA22+AGE+PTGENDER,data=long_dat)

# Standardize the residuals and append to data frame
long_dat$res <- rstandard(results)

# Create density plot of the residuals
ggplot(long_dat, aes(x = res)) +
  geom_density(fill = "orange", alpha = 0.5) +
  labs(x = "Residual Score", y = "Density") +
  ggtitle("Distribution of Residuals")
```

## How to interpret the Residuals?

It is important to correctly interpret the residual scores. The correct way to interpret them is, that a high residual score means that the individual has over-performed relative to his or her genetic capacity. See for example in this table for a short proof:

```{r, echo=FALSE}
residuals <- results$residuals # get residuals
predicted_scores <- predict(results) # get predicted scores for each individual

combined_df <- data.frame(Actual = long_dat$PTEDUCAT, Predicted = as.numeric(predicted_scores), Residuals = as.numeric(residuals)) # Combine residuals, predicted scores, and actual scores into one data frame

head(combined_df) # present data frame as example
```

It is interesting to see that the residual plot is not normally distributed. 
**Does this suggest that we should continue using non-parametric analysis 
techniques?**

```{r, echo=FALSE}
# Create a residual plot
residual_plot <- ggplot() +
  geom_qq(aes(sample = residuals)) +
  geom_qq_line() +
  labs(title = "Normal Q-Q Plot of Residuals") +
  theme_minimal()

residual_plot
```

# Survival Analysis

Using the ntile function from dplyr, the lower thirtile will be assigned value 1 (~ negative residual), middle thirtile value 2 and upper thirtile value 3 (~positive residual).

```{r, echo=FALSE}
# Divide the standardized residuals into upper, middle and lower quartile
long_dat$thirtile <- ntile(long_dat$res, 3)
```

## Mini-Mental State Examination (MMSE)

```{r, echo=FALSE, message=FALSE}
long_dat$MMSE_cut <- ifelse(long_dat$MMSE < 25, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), MMSE_cut) ~ thirtile, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, main = "Kaplan-Meier Survival Curve", xlab = "Time", ylab = "Survival Probability", col = c("blue", "green", "red"), lwd = 2)
legend("bottomleft", legend = c("under-performed", "middle", "over-performed"), col = c("blue", "green", "red"), lwd = 2)

# Log Rank Test 
logrank_test <- list()
logrank_test$MMSE <- long_dat %>%
  filter(as.integer(VISCODE) <= 9, thirtile != 2) %>%
  survdiff(Surv(as.integer(VISCODE), MMSE_cut) ~ thirtile, data = .)
logrank_test$MMSE

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(MMSE_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(MMSE_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("blue", "orange"), labels = c("0", "1")) +
  facet_wrap(~ thirtile, ncol = 3, 
             labeller = labeller(thirtile = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal()
```

## Alzheimer's Disease Assessment Scale 

### ADAS11

```{r, echo=FALSE, message=FALSE}
cvalue <- list()
cvalue$ADAS11 <- mean(wide_dat$ADAS11_0, na.rm=TRUE) + 2* sd(wide_dat$ADAS11_0, na.rm = TRUE)

long_dat$ADAS11_cut <- ifelse(long_dat$ADAS11 > cvalue$ADAS11, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), ADAS11_cut) ~ thirtile, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, main = "Kaplan-Meier Survival Curve", xlab = "Time", ylab = "Survival Probability", col = c("blue", "green", "red"), lwd = 2)
legend("bottomleft", legend = c("under-performed", "middle", "over-performed"), col = c("blue", "green", "red"), lwd = 2)

# Log Rank Test 
logrank_test$ADAS11 <- long_dat %>%
  filter(as.integer(VISCODE) <= 9, thirtile != 2) %>%
  survdiff(Surv(as.integer(VISCODE), ADAS11_cut) ~ thirtile, data = .)
logrank_test$ADAS11

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(ADAS11_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(ADAS11_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("blue", "orange"), labels = c("0", "1")) +
  facet_wrap(~ thirtile, ncol = 3, 
             labeller = labeller(thirtile = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal()
```
### ADAS13
```{r, echo=FALSE, message=FALSE}
cvalue$ADAS13 <- mean(wide_dat$ADAS13_0, na.rm=TRUE) + 2* sd(wide_dat$ADAS13_0, na.rm = TRUE)

long_dat$ADAS13_cut <- ifelse(long_dat$ADAS13 > cvalue$ADAS13, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), ADAS13_cut) ~ thirtile, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, main = "Kaplan-Meier Survival Curve", xlab = "Time", ylab = "Survival Probability", col = c("blue", "green", "red"), lwd = 2)
legend("bottomleft", legend = c("under-performed", "middle", "over-performed"), col = c("blue", "green", "red"), lwd = 2)

# Log Rank Test 
logrank_test$ADAS13 <- long_dat %>%
  filter(thirtile != 2) %>%
  survdiff(Surv(as.integer(VISCODE), ADAS13_cut) ~ thirtile, data = .)
logrank_test$ADAS13

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(ADAS13_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(ADAS13_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("blue", "orange"), labels = c("0", "1")) +
  facet_wrap(~ thirtile, ncol = 3, 
             labeller = labeller(thirtile = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal()
```
### ADASQ4

```{r, echo=FALSE, message=FALSE}
cvalue$ADASQ4 <- mean(wide_dat$ADASQ4_0, na.rm=TRUE) + 2* sd(wide_dat$ADASQ4_0, na.rm = TRUE)

long_dat$ADASQ4_cut <- ifelse(long_dat$ADASQ4 > cvalue$ADASQ4, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), ADASQ4_cut) ~ thirtile, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, main = "Kaplan-Meier Survival Curve", xlab = "Time", ylab = "Survival Probability", col = c("blue", "green", "red"), lwd = 2)
legend("bottomleft", legend = c("under-performed", "middle", "over-performed"), col = c("blue", "green", "red"), lwd = 2)

# Log Rank Test 
logrank_test$ADASQ4 <- long_dat %>%
  filter(thirtile != 2) %>%
  survdiff(Surv(as.integer(VISCODE), ADASQ4_cut) ~ thirtile, data = .)
logrank_test$ADASQ4

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(ADASQ4_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(ADASQ4_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("blue", "orange"), labels = c("0", "1")) +
  facet_wrap(~ thirtile, ncol = 3, 
             labeller = labeller(thirtile = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal()
```

### CDRSB

```{r, echo=FALSE, message=FALSE}
cvalue$CDRSB <- mean(wide_dat$CDRSB_0, na.rm=TRUE) + 2* sd(wide_dat$CDRSB_0, na.rm = TRUE)

long_dat$CDRSB_cut <- ifelse(long_dat$CDRSB > cvalue$CDRSB, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), CDRSB_cut) ~ thirtile, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, main = "Kaplan-Meier Survival Curve", xlab = "Time", ylab = "Survival Probability", col = c("blue", "green", "red"), lwd = 2)
legend("bottomleft", legend = c("under-performed", "middle", "over-performed"), col = c("blue", "green", "red"), lwd = 2)

# Log Rank Test 
logrank_test$CDRSB <- long_dat %>%
  filter(thirtile != 2) %>%
  survdiff(Surv(as.integer(VISCODE), CDRSB_cut) ~ thirtile, data = .)
logrank_test$CDRSB

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(CDRSB_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(CDRSB_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("blue", "orange"), labels = c("0", "1")) +
  facet_wrap(~ thirtile, ncol = 3, 
             labeller = labeller(thirtile = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal()
```

### DIGITSCORE

```{r, echo=FALSE, message=FALSE}
cvalue$DIGITSCOR <- mean(wide_dat$DIGITSCOR_0, na.rm=TRUE) + 2* sd(wide_dat$DIGITSCOR_0, na.rm = TRUE)

long_dat$DIGITSCOR_cut <- ifelse(long_dat$DIGITSCOR > cvalue$DIGITSCOR, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), DIGITSCOR_cut) ~ thirtile, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, main = "Kaplan-Meier Survival Curve", xlab = "Time", ylab = "Survival Probability", col = c("blue", "green", "red"), lwd = 2)
legend("bottomleft", legend = c("under-performed", "middle", "over-performed"), col = c("blue", "green", "red"), lwd = 2)

# Log Rank Test 
logrank_test$DIGITSCOR <- long_dat %>%
  filter(thirtile != 2) %>%
  survdiff(Surv(as.integer(VISCODE), DIGITSCOR_cut) ~ thirtile, data = .)
logrank_test$DIGITSCOR

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(DIGITSCOR_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(DIGITSCOR_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("blue", "orange"), labels = c("0", "1")) +
  facet_wrap(~ thirtile, ncol = 3, 
             labeller = labeller(thirtile = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal()
```

### ECOGPTDIVAT

```{r, echo=FALSE, message=FALSE}
cvalue$EcogPtDivatt <- mean(wide_dat$EcogPtDivatt_0, na.rm=TRUE) + 2* sd(wide_dat$EcogPtDivatt_0, na.rm = TRUE)

long_dat$EcogPtDivatt_cut <- ifelse(long_dat$EcogPtDivatt > cvalue$EcogPtDivatt, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), EcogPtDivatt_cut) ~ thirtile, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, main = "Kaplan-Meier Survival Curve", xlab = "Time", ylab = "Survival Probability", col = c("blue", "green", "red"), lwd = 2)
legend("bottomleft", legend = c("under-performed", "middle", "over-performed"), col = c("blue", "green", "red"), lwd = 2)

# Log Rank Test 
logrank_test$EcogPtDivatt <- long_dat %>%
  filter(thirtile != 2) %>%
  survdiff(Surv(as.integer(VISCODE), EcogPtDivatt_cut) ~ thirtile, data = .)
logrank_test$EcogPtDivatt

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(EcogPtDivatt_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(EcogPtDivatt_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("blue", "orange"), labels = c("0", "1")) +
  facet_wrap(~ thirtile, ncol = 3, 
             labeller = labeller(thirtile = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal()
```

### ECOGSPVISPAT

```{r, echo=FALSE, message=FALSE}
cvalue$EcogSPVisspat <- mean(wide_dat$EcogSPVisspat_0, na.rm=TRUE) + 2* sd(wide_dat$EcogSPVisspat_0, na.rm = TRUE)

long_dat$EcogSPVisspat_cut <- ifelse(long_dat$EcogSPVisspat > cvalue$EcogSPVisspat, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), EcogSPVisspat_cut) ~ thirtile, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, main = "Kaplan-Meier Survival Curve", xlab = "Time", ylab = "Survival Probability", col = c("blue", "green", "red"), lwd = 2)
legend("bottomleft", legend = c("under-performed", "middle", "over-performed"), col = c("blue", "green", "red"), lwd = 2)

# Log Rank Test 
logrank_test$EcogSPVisspat <- long_dat %>%
  filter(thirtile != 2) %>%
  survdiff(Surv(as.integer(VISCODE), EcogSPVisspat_cut) ~ thirtile, data = .)
logrank_test$EcogSPVisspat

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(EcogSPVisspat_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(EcogSPVisspat_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("blue", "orange"), labels = c("0", "1")) +
  facet_wrap(~ thirtile, ncol = 3, 
             labeller = labeller(thirtile = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal()
```

### FAQ

```{r, echo=FALSE, message=FALSE}
cvalue$FAQ <- mean(wide_dat$FAQ_0, na.rm=TRUE) + 2* sd(wide_dat$FAQ_0, na.rm = TRUE)

long_dat$FAQ_cut <- ifelse(long_dat$FAQ > cvalue$FAQ, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), FAQ_cut) ~ thirtile, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, main = "Kaplan-Meier Survival Curve", xlab = "Time", ylab = "Survival Probability", col = c("blue", "green", "red"), lwd = 2)
legend("bottomleft", legend = c("under-performed", "middle", "over-performed"), col = c("blue", "green", "red"), lwd = 2)

# Log Rank Test 
logrank_test$FAQ <- long_dat %>%
  filter(thirtile != 2) %>%
  survdiff(Surv(as.integer(VISCODE), FAQ_cut) ~ thirtile, data = .)
logrank_test$FAQ

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(FAQ_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(FAQ_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("blue", "orange"), labels = c("0", "1")) +
  facet_wrap(~ thirtile, ncol = 3, 
             labeller = labeller(thirtile = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal()
```

### LDELTOTAL

```{r, echo=FALSE, message=FALSE}
cvalue$LDELTOTAL <- mean(wide_dat$LDELTOTAL_0, na.rm=TRUE) + 2* sd(wide_dat$LDELTOTAL_0, na.rm = TRUE)

long_dat$LDELTOTAL_cut <- ifelse(long_dat$LDELTOTAL > cvalue$LDELTOTAL, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), LDELTOTAL_cut) ~ thirtile, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, main = "Kaplan-Meier Survival Curve", xlab = "Time", ylab = "Survival Probability", col = c("blue", "green", "red"), lwd = 2)
legend("bottomleft", legend = c("under-performed", "middle", "over-performed"), col = c("blue", "green", "red"), lwd = 2)

# Log Rank Test 
logrank_test$LDELTOTAL <- long_dat %>%
  filter(thirtile != 2) %>%
  survdiff(Surv(as.integer(VISCODE), LDELTOTAL_cut) ~ thirtile, data = .)
logrank_test$LDELTOTAL

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(LDELTOTAL_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(LDELTOTAL_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("blue", "orange"), labels = c("0", "1")) +
  facet_wrap(~ thirtile, ncol = 3, 
             labeller = labeller(thirtile = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal()
```

### MOCA

```{r, echo=FALSE, message=FALSE}
cvalue$MOCA <- mean(wide_dat$MOCA_0, na.rm=TRUE) + 2* sd(wide_dat$MOCA_0, na.rm = TRUE)

long_dat$MOCA_cut <- ifelse(long_dat$MOCA > cvalue$MOCA, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), MOCA_cut) ~ thirtile, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, main = "Kaplan-Meier Survival Curve", xlab = "Time", ylab = "Survival Probability", col = c("blue", "green", "red"), lwd = 2)
legend("bottomleft", legend = c("under-performed", "middle", "over-performed"), col = c("blue", "green", "red"), lwd = 2)

# Log Rank Test 
logrank_test$MOCA <- long_dat %>%
  filter(thirtile != 2) %>%
  survdiff(Surv(as.integer(VISCODE), MOCA_cut) ~ thirtile, data = .)
logrank_test$MOCA

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(MOCA_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(MOCA_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("blue", "orange"), labels = c("0", "1")) +
  facet_wrap(~ thirtile, ncol = 3, 
             labeller = labeller(thirtile = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal()
```

### RAVLT_Forgetting

```{r, echo=FALSE, message=FALSE}
cvalue$RAVLT_forgetting <- mean(wide_dat$RAVLT_forgetting_0, na.rm=TRUE) + 2* sd(wide_dat$RAVLT_forgetting_0, na.rm = TRUE)

long_dat$RAVLT_forgetting_cut <- ifelse(long_dat$RAVLT_forgetting > cvalue$RAVLT_forgetting, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), RAVLT_forgetting_cut) ~ thirtile, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, main = "Kaplan-Meier Survival Curve", xlab = "Time", ylab = "Survival Probability", col = c("blue", "green", "red"), lwd = 2)
legend("bottomleft", legend = c("under-performed", "middle", "over-performed"), col = c("blue", "green", "red"), lwd = 2)

# Log Rank Test 
logrank_test$RAVLT_forgetting <- long_dat %>%
  filter(thirtile != 2) %>%
  survdiff(Surv(as.integer(VISCODE), RAVLT_forgetting_cut) ~ thirtile, data = .)
logrank_test$RAVLT_forgetting

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(RAVLT_forgetting_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(RAVLT_forgetting_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("blue", "orange"), labels = c("0", "1")) +
  facet_wrap(~ thirtile, ncol = 3, 
             labeller = labeller(thirtile = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal()
```

### RAVLT_Immediate

```{r, echo=FALSE, message=FALSE}
cvalue$RAVLT_immediate <- mean(wide_dat$RAVLT_immediate_0, na.rm=TRUE) + 2* sd(wide_dat$RAVLT_immediate_0, na.rm = TRUE)

long_dat$RAVLT_immediate_cut <- ifelse(long_dat$RAVLT_immediate > cvalue$RAVLT_immediate, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), RAVLT_immediate_cut) ~ thirtile, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, main = "Kaplan-Meier Survival Curve", xlab = "Time", ylab = "Survival Probability", col = c("blue", "green", "red"), lwd = 2)
legend("bottomleft", legend = c("under-performed", "middle", "over-performed"), col = c("blue", "green", "red"), lwd = 2)

# Log Rank Test 
logrank_test$RAVLT_immediate <- long_dat %>%
  filter(thirtile != 2) %>%
  survdiff(Surv(as.integer(VISCODE), RAVLT_immediate_cut) ~ thirtile, data = .)
logrank_test$RAVLT_immediate

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(RAVLT_immediate_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(RAVLT_immediate_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("blue", "orange"), labels = c("0", "1")) +
  facet_wrap(~ thirtile, ncol = 3, 
             labeller = labeller(thirtile = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal()
```

### RAVLT_learning

```{r, echo=FALSE, message=FALSE}
cvalue$RAVLT_learning <- mean(wide_dat$RAVLT_learning_0, na.rm=TRUE) + 2* sd(wide_dat$RAVLT_learning_0, na.rm = TRUE)

long_dat$RAVLT_learning_cut <- ifelse(long_dat$RAVLT_learning > cvalue$RAVLT_learning, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), RAVLT_learning_cut) ~ thirtile, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, main = "Kaplan-Meier Survival Curve", xlab = "Time", ylab = "Survival Probability", col = c("blue", "green", "red"), lwd = 2)
legend("bottomleft", legend = c("under-performed", "middle", "over-performed"), col = c("blue", "green", "red"), lwd = 2)

# Log Rank Test 
logrank_test$RAVLT_learning <- long_dat %>%
  filter(thirtile != 2) %>%
  survdiff(Surv(as.integer(VISCODE), RAVLT_learning_cut) ~ thirtile, data = .)
logrank_test$RAVLT_learning

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(RAVLT_learning_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(RAVLT_learning_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("blue", "orange"), labels = c("0", "1")) +
  facet_wrap(~ thirtile, ncol = 3, 
             labeller = labeller(thirtile = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal()
```

### RAVLT_forgetting

```{r, echo=FALSE, message=FALSE}
cvalue$RAVLT_forgetting <- mean(wide_dat$RAVLT_forgetting_0, na.rm=TRUE) + 2* sd(wide_dat$RAVLT_forgetting_0, na.rm = TRUE)

long_dat$RAVLT_forgetting_cut <- ifelse(long_dat$RAVLT_forgetting > cvalue$RAVLT_forgetting, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), RAVLT_forgetting_cut) ~ thirtile, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, main = "Kaplan-Meier Survival Curve", xlab = "Time", ylab = "Survival Probability", col = c("blue", "green", "red"), lwd = 2)
legend("bottomleft", legend = c("under-performed", "middle", "over-performed"), col = c("blue", "green", "red"), lwd = 2)

# Log Rank Test 
logrank_test$RAVLT_forgetting <- long_dat %>%
  filter(thirtile != 2) %>%
  survdiff(Surv(as.integer(VISCODE), RAVLT_forgetting_cut) ~ thirtile, data = .)
logrank_test$RAVLT_forgetting

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(RAVLT_forgetting_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(RAVLT_forgetting_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("blue", "orange"), labels = c("0", "1")) +
  facet_wrap(~ thirtile, ncol = 3, 
             labeller = labeller(thirtile = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal()
```

### TRABSCORE

```{r, echo=FALSE, message=FALSE}
cvalue$TRABSCOR <- mean(wide_dat$TRABSCOR_0, na.rm=TRUE) + 2* sd(wide_dat$TRABSCOR_0, na.rm = TRUE)

long_dat$TRABSCOR_cut <- ifelse(long_dat$TRABSCOR > cvalue$TRABSCOR, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), TRABSCOR_cut) ~ thirtile, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, main = "Kaplan-Meier Survival Curve", xlab = "Time", ylab = "Survival Probability", col = c("blue", "green", "red"), lwd = 2)
legend("bottomleft", legend = c("under-performed", "middle", "over-performed"), col = c("blue", "green", "red"), lwd = 2)

# Log Rank Test 
logrank_test$TRABSCOR <- long_dat %>%
  filter(thirtile != 2) %>%
  survdiff(Surv(as.integer(VISCODE), TRABSCOR_cut) ~ thirtile, data = .)
logrank_test$TRABSCOR

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(TRABSCOR_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(TRABSCOR_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("blue", "orange"), labels = c("0", "1")) +
  facet_wrap(~ thirtile, ncol = 3, 
             labeller = labeller(thirtile = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal()
```

## Patient's Everyday Cognition (EcogPtLang)

```{r, echo=FALSE}
cvalue$EcogPtLang <- mean(wide_dat$EcogPtLang_0, na.rm=TRUE) + 2* sd(wide_dat$EcogPtLang_0, na.rm = TRUE)

long_dat$EcogPtLang_cut <- ifelse(long_dat$EcogPtLang > cvalue$EcogPtLang, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), EcogPtLang_cut) ~ thirtile, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, main = "Kaplan-Meier Survival Curve", xlab = "Time", ylab = "Survival Probability", col = c("blue", "green", "red"), lwd = 2)
legend("bottomleft", legend = c("under-performed", "middle", "over-performed"), col = c("blue", "green", "red"), lwd = 2)

# Log Rank Test 
logrank_test$EcogPtLang <- long_dat %>%
  filter(thirtile != 2) %>%
  survdiff(Surv(as.integer(VISCODE), EcogPtLang_cut) ~ thirtile, data = .)
logrank_test$EcogPtLang

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(EcogPtLang_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(EcogPtLang_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("blue", "orange"), labels = c("0", "1")) +
  facet_wrap(~ thirtile, ncol = 3, 
             labeller = labeller(thirtile = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal()
```

## Patient's Everyday Cognition (EcogPtMem)

```{r, echo=FALSE}
cvalue$EcogPtMem <- mean(wide_dat$EcogPtMem_0, na.rm=TRUE) + 2* sd(wide_dat$EcogPtMem_0, na.rm = TRUE)

long_dat$EcogPtMem_cut <- ifelse(long_dat$EcogPtMem > cvalue$EcogPtMem, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), EcogPtMem_cut) ~ thirtile, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, main = "Kaplan-Meier Survival Curve", xlab = "Time", ylab = "Survival Probability", col = c("blue", "green", "red"), lwd = 2)
legend("bottomleft", legend = c("under-performed", "middle", "over-performed"), col = c("blue", "green", "red"), lwd = 2)

# Log Rank Test 
logrank_test$EcogPtMem <- long_dat %>%
  filter(thirtile != 2) %>%
  survdiff(Surv(as.integer(VISCODE), EcogPtMem_cut) ~ thirtile, data = .)
logrank_test$EcogPtMem

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(EcogPtMem_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(EcogPtMem_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("blue", "orange"), labels = c("0", "1")) +
  facet_wrap(~ thirtile, ncol = 3, 
             labeller = labeller(thirtile = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal()
```

## Patient's Everyday Cognition (EcogPtOrgan)

```{r, echo=FALSE}
cvalue$EcogPtOrgan <- mean(wide_dat$EcogPtOrgan_0, na.rm=TRUE) + 2* sd(wide_dat$EcogPtOrgan_0, na.rm = TRUE)

long_dat$EcogPtOrgan_cut <- ifelse(long_dat$EcogPtOrgan > cvalue$EcogPtOrgan, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), EcogPtOrgan_cut) ~ thirtile, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, main = "Kaplan-Meier Survival Curve", xlab = "Time", ylab = "Survival Probability", col = c("blue", "green", "red"), lwd = 2)
legend("bottomleft", legend = c("under-performed", "middle", "over-performed"), col = c("blue", "green", "red"), lwd = 2)

# Log Rank Test 
logrank_test$EcogPtOrgan <- long_dat %>%
  filter(thirtile != 2) %>%
  survdiff(Surv(as.integer(VISCODE), EcogPtOrgan_cut) ~ thirtile, data = .)
logrank_test$EcogPtOrgan

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(EcogPtOrgan_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(EcogPtOrgan_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("blue", "orange"), labels = c("0", "1")) +
  facet_wrap(~ thirtile, ncol = 3, 
             labeller = labeller(thirtile = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal()
```

## Patient's Everyday Cognition (EcogPtPlan)

```{r, echo=FALSE}
cvalue$EcogPtPlan <- mean(wide_dat$EcogPtPlan_0, na.rm=TRUE) + 2* sd(wide_dat$EcogPtPlan_0, na.rm = TRUE)

long_dat$EcogPtPlan_cut <- ifelse(long_dat$EcogPtPlan > cvalue$EcogPtPlan, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), EcogPtPlan_cut) ~ thirtile, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, main = "Kaplan-Meier Survival Curve", xlab = "Time", ylab = "Survival Probability", col = c("blue", "green", "red"), lwd = 2)
legend("bottomleft", legend = c("under-performed", "middle", "over-performed"), col = c("blue", "green", "red"), lwd = 2)

# Log Rank Test 
logrank_test$EcogPtPlan <- long_dat %>%
  filter(thirtile != 2) %>%
  survdiff(Surv(as.integer(VISCODE), EcogPtPlan_cut) ~ thirtile, data = .)
logrank_test$EcogPtPlan

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(EcogPtPlan_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(EcogPtPlan_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("blue", "orange"), labels = c("0", "1")) +
  facet_wrap(~ thirtile, ncol = 3, 
             labeller = labeller(thirtile = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal()
```

## Patient's Everyday Cognition (EcogPtTotal)

```{r, echo=FALSE}
cvalue$EcogPtTotal <- mean(wide_dat$EcogPtTotal_0, na.rm=TRUE) + 2* sd(wide_dat$EcogPtTotal_0, na.rm = TRUE)

long_dat$EcogPtTotal_cut <- ifelse(long_dat$EcogPtTotal > cvalue$EcogPtTotal, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), EcogPtTotal_cut) ~ thirtile, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, main = "Kaplan-Meier Survival Curve", xlab = "Time", ylab = "Survival Probability", col = c("blue", "green", "red"), lwd = 2)
legend("bottomleft", legend = c("under-performed", "middle", "over-performed"), col = c("blue", "green", "red"), lwd = 2)

# Log Rank Test 
logrank_test$EcogPtTotal <- long_dat %>%
  filter(thirtile != 2) %>%
  survdiff(Surv(as.integer(VISCODE), EcogPtTotal_cut) ~ thirtile, data = .)
logrank_test$EcogPtTotal

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(EcogPtTotal_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(EcogPtTotal_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("blue", "orange"), labels = c("0", "1")) +
  facet_wrap(~ thirtile, ncol = 3, 
             labeller = labeller(thirtile = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal()
```

## Patient's Everyday Cognition (EcogPtVisspat)

```{r, echo=FALSE}
cvalue$EcogPtVisspat <- mean(wide_dat$EcogPtVisspat_0, na.rm=TRUE) + 2* sd(wide_dat$EcogPtVisspat_0, na.rm = TRUE)

long_dat$EcogPtVisspat_cut <- ifelse(long_dat$EcogPtVisspat > cvalue$EcogPtVisspat, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), EcogPtVisspat_cut) ~ thirtile, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, main = "Kaplan-Meier Survival Curve", xlab = "Time", ylab = "Survival Probability", col = c("blue", "green", "red"), lwd = 2)
legend("bottomleft", legend = c("under-performed", "middle", "over-performed"), col = c("blue", "green", "red"), lwd = 2)

# Log Rank Test 
logrank_test$EcogPtVisspat <- long_dat %>%
  filter(thirtile != 2) %>%
  survdiff(Surv(as.integer(VISCODE), EcogPtVisspat_cut) ~ thirtile, data = .)
logrank_test$EcogPtVisspat

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(EcogPtVisspat_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(EcogPtVisspat_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("blue", "orange"), labels = c("0", "1")) +
  facet_wrap(~ thirtile, ncol = 3, 
             labeller = labeller(thirtile = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal()
```

## Self-Reported Everyday Cognitive Abilities Questionnaire (EcogSPDivatt)

```{r, echo=FALSE}
cvalue$EcogSPDivatt <- mean(wide_dat$EcogSPDivatt_0, na.rm=TRUE) + 2* sd(wide_dat$EcogSPDivatt_0, na.rm = TRUE)

long_dat$EcogSPDivatt_cut <- ifelse(long_dat$EcogSPDivatt > cvalue$EcogSPDivatt, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), EcogSPDivatt_cut) ~ thirtile, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, main = "Kaplan-Meier Survival Curve", xlab = "Time", ylab = "Survival Probability", col = c("blue", "green", "red"), lwd = 2)
legend("bottomleft", legend = c("under-performed", "middle", "over-performed"), col = c("blue", "green", "red"), lwd = 2)

# Log Rank Test 
logrank_test$EcogSPDivatt <- long_dat %>%
  filter(thirtile != 2) %>%
  survdiff(Surv(as.integer(VISCODE), EcogSPDivatt_cut) ~ thirtile, data = .)
logrank_test$EcogSPDivatt

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(EcogSPDivatt_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(EcogSPDivatt_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("blue", "orange"), labels = c("0", "1")) +
  facet_wrap(~ thirtile, ncol = 3, 
             labeller = labeller(thirtile = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal()
```


## Self-Reported Everyday Cognitive Abilities Questionnaire (EcogSPLang)

```{r, echo=FALSE}
cvalue$EcogSPLang <- mean(wide_dat$EcogSPLang_0, na.rm=TRUE) + 2* sd(wide_dat$EcogSPLang_0, na.rm = TRUE)

long_dat$EcogSPLang_cut <- ifelse(long_dat$EcogSPLang > cvalue$EcogSPLang, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), EcogSPLang_cut) ~ thirtile, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, main = "Kaplan-Meier Survival Curve", xlab = "Time", ylab = "Survival Probability", col = c("blue", "green", "red"), lwd = 2)
legend("bottomleft", legend = c("under-performed", "middle", "over-performed"), col = c("blue", "green", "red"), lwd = 2)

# Log Rank Test 
logrank_test$EcogSPLang <- long_dat %>%
  filter(thirtile != 2) %>%
  survdiff(Surv(as.integer(VISCODE), EcogSPLang_cut) ~ thirtile, data = .)
logrank_test$EcogSPLang

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(EcogSPLang_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(EcogSPLang_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("blue", "orange"), labels = c("0", "1")) +
  facet_wrap(~ thirtile, ncol = 3, 
             labeller = labeller(thirtile = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal()
```


## Self-Reported Everyday Cognitive Abilities Questionnaire (EcogSPMem)

```{r, echo=FALSE}
cvalue$EcogSPMem <- mean(wide_dat$EcogSPMem_0, na.rm=TRUE) + 2* sd(wide_dat$EcogSPMem_0, na.rm = TRUE)

long_dat$EcogSPMem_cut <- ifelse(long_dat$EcogSPMem > cvalue$EcogSPMem, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), EcogSPMem_cut) ~ thirtile, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, main = "Kaplan-Meier Survival Curve", xlab = "Time", ylab = "Survival Probability", col = c("blue", "green", "red"), lwd = 2)
legend("bottomleft", legend = c("under-performed", "middle", "over-performed"), col = c("blue", "green", "red"), lwd = 2)

# Log Rank Test 
logrank_test$EcogSPMem <- long_dat %>%
  filter(thirtile != 2) %>%
  survdiff(Surv(as.integer(VISCODE), EcogSPMem_cut) ~ thirtile, data = .)
logrank_test$EcogSPMem

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(EcogSPMem_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(EcogSPMem_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("blue", "orange"), labels = c("0", "1")) +
  facet_wrap(~ thirtile, ncol = 3, 
             labeller = labeller(thirtile = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal()
```


## Self-Reported Everyday Cognitive Abilities Questionnaire (EcogSPOrgan)

```{r, echo=FALSE}
cvalue$EcogSPOrgan <- mean(wide_dat$EcogSPOrgan_0, na.rm=TRUE) + 2* sd(wide_dat$EcogSPOrgan_0, na.rm = TRUE)

long_dat$EcogSPOrgan_cut <- ifelse(long_dat$EcogSPOrgan > cvalue$EcogSPOrgan, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), EcogSPOrgan_cut) ~ thirtile, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, main = "Kaplan-Meier Survival Curve", xlab = "Time", ylab = "Survival Probability", col = c("blue", "green", "red"), lwd = 2)
legend("bottomleft", legend = c("under-performed", "middle", "over-performed"), col = c("blue", "green", "red"), lwd = 2)

# Log Rank Test 
logrank_test$EcogSPOrgan <- long_dat %>%
  filter(thirtile != 2) %>%
  survdiff(Surv(as.integer(VISCODE), EcogSPOrgan_cut) ~ thirtile, data = .)
logrank_test$EcogSPOrgan

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(EcogSPOrgan_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(EcogSPOrgan_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("blue", "orange"), labels = c("0", "1")) +
  facet_wrap(~ thirtile, ncol = 3, 
             labeller = labeller(thirtile = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal()
```


## Self-Reported Everyday Cognitive Abilities Questionnaire (EcogSPPlan)

```{r, echo=FALSE}
cvalue$EcogSPPlan <- mean(wide_dat$EcogSPPlan_0, na.rm=TRUE) + 2* sd(wide_dat$EcogSPPlan_0, na.rm = TRUE)

long_dat$EcogSPPlan_cut <- ifelse(long_dat$EcogSPPlan > cvalue$EcogSPPlan, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), EcogSPPlan_cut) ~ thirtile, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, main = "Kaplan-Meier Survival Curve", xlab = "Time", ylab = "Survival Probability", col = c("blue", "green", "red"), lwd = 2)
legend("bottomleft", legend = c("under-performed", "middle", "over-performed"), col = c("blue", "green", "red"), lwd = 2)

# Log Rank Test 
logrank_test$EcogSPPlan <- long_dat %>%
  filter(thirtile != 2) %>%
  survdiff(Surv(as.integer(VISCODE), EcogSPPlan_cut) ~ thirtile, data = .)
logrank_test$EcogSPPlan

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(EcogSPPlan_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(EcogSPPlan_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("blue", "orange"), labels = c("0", "1")) +
  facet_wrap(~ thirtile, ncol = 3, 
             labeller = labeller(thirtile = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal()
```



## Self-Reported Everyday Cognitive Abilities Questionnaire (EcogSPTotal)

```{r, echo=FALSE}
cvalue$EcogSPTotal <- mean(wide_dat$EcogSPTotal_0, na.rm=TRUE) + 2* sd(wide_dat$EcogSPTotal_0, na.rm = TRUE)

long_dat$EcogSPTotal_cut <- ifelse(long_dat$EcogSPTotal > cvalue$EcogSPTotal, 1, 0)

# Fit the Kaplan-Meier estimator
surv_fit <- long_dat %>%
  filter(as.integer(VISCODE) <= 9) %>%
  survfit(Surv(as.integer(VISCODE), EcogSPTotal_cut) ~ thirtile, data = .)

# Create the Kaplan-Meier survival plot
plot(surv_fit, main = "Kaplan-Meier Survival Curve", xlab = "Time", ylab = "Survival Probability", col = c("blue", "green", "red"), lwd = 2)
legend("bottomleft", legend = c("under-performed", "middle", "over-performed"), col = c("blue", "green", "red"), lwd = 2)

# Log Rank Test 
logrank_test$EcogSPTotal <- long_dat %>%
  filter(thirtile != 2) %>%
  survdiff(Surv(as.integer(VISCODE), EcogSPTotal_cut) ~ thirtile, data = .)
logrank_test$EcogSPTotal

# Histogram depicting the number of people measured at each time point by group by outcome
ggplot(long_dat %>% filter(!is.na(EcogSPTotal_cut)), 
       aes(x = as.integer(VISCODE), fill = factor(EcogSPTotal_cut))) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 2) +
  scale_fill_manual(values = c("blue", "orange"), labels = c("0", "1")) +
  facet_wrap(~ thirtile, ncol = 3, 
             labeller = labeller(thirtile = c("1" = "Underperformed", 
                                              "2" = "Average", 
                                              "3" = "Overperformed"))) +
  labs(title = "Number of observations by time by group by outcome",
       x = "Time", y = "Number of participants",
       fill = "Legend Title") +
  theme_minimal()
```

